<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Selfy AI â€” æ˜“ç»è§‚ç›¸</title>
  <script>window.API_BASE="https://yi-t31x.onrender.com";</script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body{background:radial-gradient(1000px 600px at 50% -200px,#f8fafc 0%,#f1f5f9 60%,#e5e7eb 100%);}
    .card{background:#fff;border-radius:16px;box-shadow:0 8px 24px rgba(0,0,0,.06);padding:20px;}
    .pill{display:inline-flex;padding:.3rem .7rem;border-radius:999px;font-size:12px;background:#f5f3ff;color:#4f46e5;}
    .h2{font-weight:600;font-size:16px;}
  </style>
</head>
<body class="text-[15px] text-gray-900">
  <div class="max-w-5xl mx-auto p-6 space-y-6">
    <header class="flex items-center justify-between">
      <div>
        <div class="text-2xl font-bold tracking-tight">Selfy AI</div>
        <div class="text-xs text-gray-500 mt-1">æ˜“ç»è§‚ç›¸ Â· å§¿æ€ / ç¥æƒ… / é¢å®¹</div>
      </div>
      <div class="text-xs text-gray-500"><a id="docs" class="underline" target="_blank">/docs</a></div>
    </header>

    <!-- ä¸Šä¼ åŒº -->
    <section class="card">
      <div class="md:flex md:items-center md:justify-between gap-6">
        <div class="flex-1">
          <div id="drop" class="border-2 border-dashed border-gray-300 rounded-xl p-6 text-center hover:border-indigo-400 transition cursor-pointer bg-gray-50">
            <div class="text-gray-600 text-sm">æ‹–æ‹½å›¾ç‰‡åˆ°è¿™é‡Œï¼Œæˆ– <span class="text-indigo-600">ç‚¹å‡»é€‰æ‹©</span><br><span class="text-xs text-gray-400">JPG/PNG â‰¤ 15MB</span></div>
            <input id="file" type="file" accept="image/*" class="hidden" />
          </div>
        </div>
        <div class="mt-4 md:mt-0 shrink-0">
          <button id="btnUpload" class="px-5 py-3 rounded-xl bg-indigo-600 text-white font-medium shadow hover:shadow-md disabled:opacity-50">å¼€å§‹åˆ†æ</button>
        </div>
      </div>
      <div id="helper" class="mt-3 text-xs text-gray-500">* ä»…ç”¨äºæœ¬æ¬¡åˆ†æï¼Œä¸åšå­˜å‚¨ã€‚</div>
      <div id="error" class="mt-3 hidden text-sm text-red-600"></div>
      <div id="progress" class="mt-3 hidden text-sm text-gray-600">æ­£åœ¨åˆ†æâ€¦â€¦</div>
      <div id="previewWrap" class="mt-4 hidden">
        <img id="preview" class="max-h-72 rounded-xl object-contain border mx-auto" />
      </div>
    </section>

    <!-- ç»“æœåŒº -->
    <section id="resultSec" class="space-y-6 hidden">

      <!-- (0) é¡¶éƒ¨ tagï¼ˆåªæ˜¾ç¤º äººæ ¼ç”»åƒ + å¯ä¿¡åº¦ï¼‰ -->
      <div class="card">
        <div class="flex items-start justify-between gap-4">
          <div class="space-y-2">
            <div id="archetypePill" class="pill">äººæ ¼ç”»åƒ</div>
            <div class="flex items-center gap-2 text-xs text-gray-500">
              <span>å¯ä¿¡åº¦</span>
              <div class="w-40 bg-gray-200 rounded-full h-2 overflow-hidden">
                <div id="confBar" class="bg-indigo-600 h-2 w-0"></div>
              </div>
              <span id="confText"></span>
            </div>
          </div>
          <div class="text-right">
            <button id="copyBtn" class="text-xs px-3 py-1.5 border rounded-lg hover:bg-gray-50">å¤åˆ¶é¡µé¢æ–‡æœ¬</button>
          </div>
        </div>
      </div>

      <!-- (1) ä¸‰è±¡ -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="card">
          <div class="h2 mb-1" id="titlePosture">ğŸ§ å§¿æ€</div>
          <div id="postureDesc" class="text-sm text-gray-700 whitespace-pre-wrap mb-2"></div>
          <div class="text-sm text-gray-700 space-y-1">
            <div id="postureHex"></div>
            <div id="postureInterp"></div>
            <div id="postureChar"></div>
          </div>
        </div>
        <div class="card">
          <div class="h2 mb-1" id="titleExpr">ğŸ™‚ ç¥æƒ…</div>
          <div id="exprDesc" class="text-sm text-gray-700 whitespace-pre-wrap mb-2"></div>
          <div class="text-sm text-gray-700 space-y-1">
            <div id="exprHex"></div>
            <div id="exprInterp"></div>
            <div id="exprChar"></div>
          </div>
        </div>
        <div class="card">
          <div class="h2 mb-1" id="titleFace">ğŸ‘¤ é¢ç›¸</div>
          <div id="faceDesc" class="text-sm text-gray-700 whitespace-pre-wrap mb-2"></div>
          <div class="text-sm text-gray-700 space-y-1">
            <div id="faceHex"></div>
            <div id="faceInterp"></div>
            <div id="faceChar"></div>
          </div>
          <div id="faceParts" class="mt-2 text-sm text-gray-700 space-y-1"></div>
        </div>
      </div>

      <!-- (2) å¦è±¡ç»„åˆï¼šç§»åˆ°ä¸‰è±¡ä¸‹é¢ -->
      <div class="card">
        <div class="h2 mb-2"><span id="comboHeader">ğŸ”® å¦è±¡ç»„åˆ</span></div>
        <div id="comboBody" class="text-sm text-gray-800 whitespace-pre-wrap"></div>
      </div>

      <!-- (3) æ€»ç»“æ€§æ ¼å°è±¡ -->
      <div class="card">
        <div class="h2 mb-2">ğŸ“Œ æ€»ç»“æ€§æ ¼å°è±¡</div>
        <div id="sumBody" class="text-sm text-gray-800 whitespace-pre-wrap"></div>
      </div>

      <!-- (4) é¢†åŸŸå»ºè®®ï¼šå„ç”¨ä¸€è¡Œ -->
      <div class="card">
        <div class="text-sm text-gray-800 whitespace-pre-wrap">
          <div>ğŸ’¼ é‡‘é’±ä¸äº‹ä¸šï¼š<span id="bizBody"></span></div>
          <div>ğŸ’— é…å¶ä¸æ„Ÿæƒ…ï¼š<span id="loveBody"></span></div>
        </div>
      </div>
    </section>

    <footer class="text-xs text-gray-500 text-center pb-8">
      <span>åç«¯ï¼š<code id="apiBase"></code></span> Â· <a class="underline" target="_blank" id="docsLink">/docs</a>
    </footer>
  </div>

<script>
const $ = (id)=>document.getElementById(id);
$("apiBase").textContent = window.API_BASE;
$("docs").href = window.API_BASE + "/docs";
$("docsLink").href = window.API_BASE + "/docs";

const drop = $("drop");
drop.addEventListener("click", ()=>$("file").click());
drop.addEventListener("dragover", e=>{ e.preventDefault(); drop.classList.add("border-indigo-400","bg-indigo-50/30"); });
drop.addEventListener("dragleave", e=>{ drop.classList.remove("border-indigo-400","bg-indigo-50/30"); });
drop.addEventListener("drop", e=>{
  e.preventDefault();
  drop.classList.remove("border-indigo-400","bg-indigo-50/30");
  const f = e.dataTransfer.files?.[0];
  if (f) setFile(f);
});
$("file").addEventListener("change", e=>{
  const f = e.target.files?.[0];
  if (f) setFile(f);
});
function setFile(f){ const url = URL.createObjectURL(f); $("preview").src=url; $("previewWrap").classList.remove("hidden"); window._file=f; }

$("btnUpload").addEventListener("click", analyze);
$("copyBtn").addEventListener("click", async ()=>{
  try{ await navigator.clipboard.writeText(document.body.innerText); const b=$("copyBtn"); const t=b.textContent; b.textContent="å·²å¤åˆ¶"; setTimeout(()=>b.textContent=t,1200);}catch(e){}
});

async function analyze(){
  const f = window._file;
  if (!f){ showErr("è¯·å…ˆé€‰æ‹©å›¾ç‰‡"); return; }
  showErr(null); $("progress").classList.remove("hidden"); $("btnUpload").disabled=true;
  const fd = new FormData(); fd.append("file", f, f.name);
  try{
    const rsp = await fetch(window.API_BASE + "/upload", { method:"POST", body: fd });
    const d = await rsp.json();
    if (!rsp.ok) throw new Error(d?.error||"æ¥å£é”™è¯¯");
    render(d);
  }catch(e){ showErr(e.message||"è¯·æ±‚å¤±è´¥"); }
  finally{ $("progress").classList.add("hidden"); $("btnUpload").disabled=false; }
}

function showErr(msg){ const el=$("error"); if(!msg){el.classList.add("hidden"); el.textContent=""; return;} el.textContent=msg; el.classList.remove("hidden"); }

function _sanitize(s){
  // æŠŠæ¨¡å‹è¿”å›çš„ '\\n' å˜æˆçœŸæ­£çš„æ¢è¡Œ
  if (typeof s !== "string") return s;
  return s.replace(/\\n/g, "\n");
}

/** æ¸²æŸ“ï¼šå¯¹æ¥ v3.6 è¾“å‡ºç»“æ„ */
function render(d){
  $("resultSec").classList.remove("hidden");

  // 0) é¡¶éƒ¨ tagï¼ˆåªæ˜¾ç¤ºäººæ ¼ç”»åƒ + å¯ä¿¡åº¦ï¼‰
  const tag = d?.meta?.headline?.tag || d.archetype || "äººæ ¼ç”»åƒ";
  const confVal = Number.isFinite(d?.meta?.headline?.confidence) ? d.meta.headline.confidence : (d.confidence||0);
  $("archetypePill").textContent = tag;
  const conf = Math.round(confVal*100);
  $("confBar").style.width = Math.min(conf,100) + "%";
  $("confText").textContent = conf + "%";

  // 1) ä¸‰è±¡æ ‡é¢˜ï¼ˆå§¿æ€/ç¥æƒ…/é¢ç›¸ â†’ è‰®å¦ï¼ˆå±±ï¼‰ï¼‰
  const titles = d?.meta?.sections_titles || {};
  $("titlePosture").textContent = "ğŸ§ " + (titles["å§¿æ€"] || "å§¿æ€");
  $("titleExpr").textContent    = "ğŸ™‚ " + (titles["ç¥æƒ…"] || "ç¥æƒ…");
  $("titleFace").textContent    = "ğŸ‘¤ " + (titles["é¢ç›¸"] || "é¢å®¹");

  // 1.1 ä¸‰è±¡å†…å®¹ï¼ˆè¯´æ˜/å¦è±¡/è§£è¯»/æ€§æ ¼å€¾å‘ï¼‰
  const t = d?.meta?.triple_analysis || {};
  function seg(name){
    const obj = t[name] || {};
    const desc = _sanitize(obj["è¯´æ˜"] || "");
    const hex = obj["å¦è±¡"]? ("å¦è±¡ï¼š"+obj["å¦è±¡"]) : "";
    const interp = obj["è§£è¯»"]? ("è§£è¯»ï¼š"+_sanitize(obj["è§£è¯»"])) : "";
    const tend = obj["æ€§æ ¼å€¾å‘"]? ("æ€§æ ¼å€¾å‘ï¼š"+_sanitize(obj["æ€§æ ¼å€¾å‘"])) : "";
    return {desc, hex, interp, tend};
  }
  const s1=seg("å§¿æ€"), s2=seg("ç¥æƒ…"), s3=seg("é¢å®¹");
  $("postureDesc").textContent=s1.desc; $("postureHex").textContent=s1.hex; $("postureInterp").textContent=s1.interp; $("postureChar").textContent=s1.tend;
  $("exprDesc").textContent=s2.desc; $("exprHex").textContent=s2.hex; $("exprInterp").textContent=s2.interp; $("exprChar").textContent=s2.tend;
  $("faceDesc").textContent=s3.desc; $("faceHex").textContent=s3.hex; $("faceInterp").textContent=s3.interp; $("faceChar").textContent=s3.tend;

  // 1.2 é¢ç›¸ç»†åˆ†ï¼ˆçœ‰/çœ¼/é¼»/å˜´/é¢§æˆ–ä¸‹å·´ï¼‰
  const fp = d?.meta?.face_parts || {};
  const lines = [];
  const mapping = [["çœ‰","çœ‰"],["çœ¼","çœ¼"],["é¼»","é¼»"],["å˜´","å˜´"],["é¢§/ä¸‹å·´","é¢§/ä¸‹å·´"]];
  mapping.forEach(([k, label])=>{
    const item = fp[k];
    if (item){
      const feat = _sanitize(item["ç‰¹å¾"]||"");
      const hex = item["å¦è±¡"]? ("ï¼ˆ"+item["å¦è±¡"]+"ï¼‰") : "";
      const inter = _sanitize(item["è§£è¯»"]||"");
      lines.push(label+"ï¼š"+feat+hex+"ï¼›"+inter);
    }
  });
  $("faceParts").textContent = lines.join("\n");

  // 2) å¦è±¡ç»„åˆï¼šæ ‡é¢˜ + è¦ç‚¹ï¼ˆå·²ç§»åˆ°ä¸‰è±¡ä¸‹é¢ï¼‰
  const comboTitleTxt = d?.meta?.combo_detail?.title || (d?.meta?.combo_title ? ("ğŸ”® å¦è±¡ç»„åˆï¼š" + d.meta.combo_title) : "ğŸ”® å¦è±¡ç»„åˆ");
  document.getElementById("comboHeader").textContent = comboTitleTxt;

  const bullets = Array.isArray(d?.meta?.combo_detail?.bullets) ? d.meta.combo_detail.bullets : [];
  const comboFallback = d?.meta?.triple_analysis?.["ç»„åˆæ„å¢ƒ"] || d.summary || "";
  document.getElementById("comboBody").textContent = bullets.length ? ("â€¢ " + _sanitize(bullets.join("\nâ€¢ "))) : _sanitize(comboFallback);

  // 3) æ€»ç»“æ€§æ ¼å°è±¡ï¼ˆä¸¤æ®µå¼ï¼‰
  const lead = d?.meta?.summary_rich?.lead || d.summary || "";
  const imgLine = d?.meta?.summary_rich?.imagery || "";
  document.getElementById("sumBody").textContent = _sanitize(imgLine ? (lead + "\n" + imgLine) : lead);

  // 4) é¢†åŸŸå»ºè®®ï¼ˆå„ç”¨ä¸€è¡Œï¼‰
  const dd = d?.meta?.domains_detail || {};
  document.getElementById("bizBody").textContent = _sanitize(dd["é‡‘é’±ä¸äº‹ä¸š"] || "â€”");
  document.getElementById("loveBody").textContent = _sanitize(dd["é…å¶ä¸æ„Ÿæƒ…"] || "â€”");
}
</script>
</body>
</html>
