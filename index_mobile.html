<script>
const SYMBOLS = {"è‰®":"å±±","ç¦»":"ç«","å…‘":"æ³½","ä¹¾":"å¤©","å¤":"åœ°","éœ‡":"é›·","å·½":"é£","å":"æ°´"};

const fileInput = document.getElementById('file');
const shotBtn = document.getElementById('shot');
const out = document.getElementById('out');
const preview = document.getElementById('preview');

shotBtn.addEventListener('click', () => { fileInput.setAttribute('capture','environment'); fileInput.click(); });
document.querySelector('label[for=file]').addEventListener('click', () => { fileInput.removeAttribute('capture'); });

fileInput.addEventListener('change', async (e) => {
  const f = e.target.files[0];
  if (!f) return;
  const url = URL.createObjectURL(f);
  preview.src = url; preview.style.display = 'block';
  out.innerHTML = '<div class="card loading">åˆ†æä¸­â€¦</div>';

  const fd = new FormData(); fd.append('file', f, f.name || 'image.jpg');
  try {
    const r = await fetch('/upload', { method: 'POST', body: fd });
    if (!r.ok) throw new Error('HTTP '+r.status);
    const data = await r.json();
    render(data);
  } catch (err) {
    out.innerHTML = `<div class="card">å‡ºé”™äº†ï¼š${(err && err.message) || err}</div>`;
  }
});

function pct(n){ try{ return Math.round(n*100); }catch(e){ return 0; } }
function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])); }

function render(d){
  const ta   = d.meta?.triple_analysis || {};
  const cb   = d.meta?.confidence_breakdown || {};
  const fps  = d.meta?.face_parts || {};
  const stat = d.meta?.domains_status_text || {};
  const sugg = d.meta?.domains_suggestion_text || {};

  // å¤´å¡ï¼šåªéœ²å‡ºâ€œå›¾ç‰‡æ¸…æ™°åº¦â€
  const headline = `
    <div class="card">
      <div class="title">Selfy AI</div>
      <div style="font-size:16px; margin:6px 0 2px;">äººæ ¼ç”»åƒï¼š${escapeHtml(d.archetype || 'â€”')}</div>
      <div class="muted">å›¾ç‰‡æ¸…æ™°åº¦ ${pct(cb['å›¾åƒæ¸…æ™°åº¦']||0)}%</div>
    </div>`;

  function triCard(name, key){
    const o = ta[key] || {};
    let hex = o['å¦è±¡'] || '';
    // é¢ç›¸ç¼ºå¦æ—¶ç”±åç«¯å·²å›å¡«ï¼Œä¸å†å‰ç«¯æ¨æ–­
    const sym = SYMBOLS[hex]||'';
    const rows = [
      `<div class="kv"><b>å¦è±¡</b><span>${hex ? `${hex}å¦ï¼ˆ${sym}ï¼‰` : 'â€”'}</span></div>`,
      `<div class="kv"><b>è§£è¯»</b><span>${escapeHtml(o['è§£è¯»']||'â€”')}</span></div>`
    ];
    if (o['ç»æ–‡æç¤º']) rows.push(`<div class="kv"><b>ç»æ–‡æç¤º</b><span>${escapeHtml(o['ç»æ–‡æç¤º'])}</span></div>`);

    // åœ¨ã€é¢ç›¸ã€‘å¡ç‰‡å†…åµŒâ€œå…­å®˜ç»†èŠ‚â€ï¼ˆçˆ»çº§åˆ«ï¼‰
    if (key === 'é¢å®¹' && fps && Object.keys(fps).length){
      const items = Object.entries(fps).map(([part, info])=>{
        const f = info?.['ç‰¹å¾'] || '';
        const h = (info?.['å¦è±¡'] || '').trim();
        const hs = h ? `${h}å¦ï¼ˆ${SYMBOLS[h]||''}ï¼‰` : 'â€”';
        const e = info?.['è§£è¯»'] || '';
        return `<div class="kv"><b>${escapeHtml(part)}</b><span>${escapeHtml(f)}ï½œ${hs}ï½œ${escapeHtml(e)}</span></div>`;
      }).join('');
      rows.push(`<div class="hr"></div>` + items);
    }
    return `<div class="card"><div class="title">${name}</div>${rows.join('')}</div>`;
  }

  // ä¸‰åˆ†è±¡ä¸€è¡Œï¼ˆä¸Šä¼ åæ˜¾ç¤ºï¼‰
  const tri = `
    <div class="grid">
      ${triCard('ğŸ§ å§¿æ€','å§¿æ€')}
      ${triCard('ğŸ™‚ ç¥æƒ…','ç¥æƒ…')}
      ${triCard('ğŸ‘¤ é¢ç›¸','é¢å®¹')}
    </div>`;

  // å…«å¦ç±»æ¯”ï¼ˆæ–‡æœ¬æ¢è¡Œï¼‰
  const combo = (()=>{
    const oc = d.meta?.overview_card || {};
    const text = (oc.summary||'').split('\n').map(ln=>escapeHtml(ln)).join('<br>');
    return `<div class="card"><div class="title">${escapeHtml(oc.title||'å…«å¦ç±»æ¯”')}</div><div class="para">${text}</div></div>`;
  })();

  // äº‹ä¸š/æ„Ÿæƒ…ï¼šå¥å­ç‰ˆï¼ˆå»æ‰ pillsï¼‰
  const domCards = (titleKey, s, g) => {
    const sTxt = (s||'').trim();
    const gTxt = (g||'').trim();
    if (!sTxt && !gTxt) return '';
    return `<div class="card">
      <div class="title">${titleKey}</div>
      ${sTxt ? `<div class="kv"><b>è¿‘æœŸçŠ¶æ€</b><span>${escapeHtml(sTxt)}</span></div>` : ''}
      ${gTxt ? `<div class="kv"><b>å»ºè®®</b><span>${escapeHtml(gTxt)}</span></div>` : ''}
    </div>`;
  };

  out.innerHTML = headline + tri + combo +
                  domCards('ğŸ’¼ äº‹ä¸š', stat['äº‹ä¸š'], sugg['äº‹ä¸š']) +
                  domCards('ğŸ’— æ„Ÿæƒ…', stat['æ„Ÿæƒ…'], sugg['æ„Ÿæƒ…']);
}
</script>
