<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Selfy AI â€” ç§»åŠ¨ä¸Šä¼ </title>
<style>
:root{--bg:#0f1115;--card:#171923;--text:#e6eaf2;--muted:#a9b1c7;--accent:#7aa2f7;--ok:#10b981;--err:#ef4444;}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Inter,"PingFang SC","Hiragino Sans GB","Microsoft YaHei",sans-serif}
.container{max-width:720px;margin:0 auto;padding:24px}
.card{background:var(--card);border-radius:16px;box-shadow:0 10px 26px rgba(0,0,0,.35);padding:20px}
h1{font-size:20px;margin:0 0 12px}
p{color:var(--muted);margin:8px 0 16px}
.uploader{display:flex;gap:10px;align-items:center}
input[type=file]{flex:1;padding:10px;border:1px dashed #3a4052;border-radius:12px;background:#10131a;color:var(--muted)}
button{padding:10px 14px;border:0;border-radius:12px;background:var(--accent);color:#0b1020;font-weight:600;cursor:pointer}
button:disabled{opacity:.55;cursor:not-allowed}
#imgPreview{margin-top:12px;border-radius:12px;max-width:100%}
.hr{height:1px;background:#242938;margin:18px 0}
#status{font-size:13px;color:var(--muted)}
.badge{display:inline-block;padding:2px 8px;border-radius:999px;background:#1f2433;color:#aab4d4;border:1px solid #2a2f42;font-size:12px}
.grid{display:grid;grid-template-columns:1fr;gap:12px}
.section{padding:12px;border:1px solid #262b3e;border-radius:12px;background:#121624}
.section h3{margin:0 0 6px;font-size:15px}
pre{white-space:pre-wrap;word-break:break-word;background:#0f1320;padding:12px;border-radius:10px;color:#d7e0ff;overflow:auto;max-height:300px}
.small{font-size:12px;color:#95a1c7}
</style>
</head>
<body>
<div class="container">
  <div class="card">
    <h1>ğŸ“¸ Selfy AI â€” YiJing Inference</h1>
    <p>ä¸Šä¼ ä¸€å¼ äººåƒï¼Œè¿”å› <span class="badge">å§¿æ€/ç¥æƒ…/é¢ç›¸</span> ä¸ <span class="badge">å¦è±¡ç»„åˆ</span>ï¼Œå¹¶ç”Ÿæˆäº‹ä¸š/æ„Ÿæƒ…çš„è¿‘æœŸçŠ¶æ€ä¸å»ºè®®ã€‚</p>
    <div class="uploader">
      <input id="file" type="file" accept="image/*">
      <button id="btn" disabled>ä¸Šä¼ åˆ†æ</button>
    </div>
    <img id="imgPreview" hidden />
    <div class="hr"></div>
    <div id="status">å°±ç»ªã€‚</div>
    <div class="hr"></div>
    <div class="grid" id="result" hidden>
      <div class="section">
        <h3>æ¦‚è§ˆ</h3>
        <div id="overview"></div>
      </div>
      <div class="section">
        <h3>ä¸‰è±¡å››æ®µå¼</h3>
        <div id="triple"></div>
      </div>
      <div class="section">
        <h3>äº‹ä¸š / æ„Ÿæƒ…</h3>
        <div id="domains"></div>
      </div>
      <div class="section">
        <h3>åŸå§‹ JSON</h3>
        <pre id="raw"></pre>
        <div class="small">å¦‚éœ€è°ƒè¯•ï¼Œå¯å¤åˆ¶æ­¤ JSON åˆ°æœ¬åœ°æŸ¥çœ‹ã€‚</div>
      </div>
    </div>
  </div>
</div>
<script>
const fileEl = document.getElementById('file');
const btnEl = document.getElementById('btn');
const imgEl = document.getElementById('imgPreview');
const statusEl = document.getElementById('status');
const resultEl = document.getElementById('result');
const overviewEl = document.getElementById('overview');
const tripleEl = document.getElementById('triple');
const domainsEl = document.getElementById('domains');
const rawEl = document.getElementById('raw');

fileEl.addEventListener('change', () => {
  btnEl.disabled = !fileEl.files.length;
  if (fileEl.files && fileEl.files[0]) {
    const url = URL.createObjectURL(fileEl.files[0]);
    imgEl.src = url; imgEl.hidden = false;
  }
});

btnEl.addEventListener('click', async () => {
  if (!fileEl.files.length) return;
  btnEl.disabled = true;
  statusEl.textContent = 'ä¸Šä¼ ä¸­â€¦';
  try {
    const form = new FormData();
    form.append('file', fileEl.files[0]);
    const r = await fetch('/upload', { method: 'POST', body: form });
    if (!r.ok) {
      const t = await r.text();
      throw new Error('HTTP ' + r.status + ' ' + t);
    }
    const data = await r.json();
    renderResult(data);
    statusEl.textContent = 'å®Œæˆã€‚';
  } catch (e) {
    console.error(e);
    statusEl.innerHTML = '<span style="color:var(--err)">å¤±è´¥ï¼š</span>' + e.message;
  } finally {
    btnEl.disabled = false;
  }
});

function esc(s){return (s??'').toString().replace(/[&<>"]/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]))}

function renderResult(j){
  resultEl.hidden = false;
  // æ¦‚è§ˆå¡
  const oc = (j.meta && j.meta.overview_card) || {};
  const head = (j.meta && j.meta.headline) || {};
  const tag = esc(head.tag||j.archetype||'');
  const conf = (head.confidence!=null)?(' Â· ç½®ä¿¡åº¦ '+Number(head.confidence).toFixed(2)) : '';
  overviewEl.innerHTML = `<div class="badge">${esc(oc.title||'å¦è±¡ç»„åˆ')}</div>
  <p>${esc(oc.summary||'')}</p>
  <div class="small">archetype: <b>${tag}</b>${conf}</div>`;

  // ä¸‰è±¡å››æ®µå¼
  const ta = (j.meta && j.meta.triple_analysis) || {};
  const parts = ['å§¿æ€','ç¥æƒ…','é¢ç›¸'];
  tripleEl.innerHTML = parts.map(k=>{
    const o = ta[k]||{};
    const gx = esc(o['å¦è±¡']||'');
    const jd = esc(o['è§£è¯»']||'');
    const xg = esc(o['æ€§æ ¼å€¾å‘']||'');
    return `<div class="section">
      <div class="badge">${k}</div>
      <div>å¦è±¡ï¼š<b>${gx}</b></div>
      <div style="margin-top:4px">${jd}</div>
      <div class="small" style="margin-top:6px">${xg}</div>
    </div>`;
  }).join('');

  // äº‹ä¸š/æ„Ÿæƒ…
  const ds = (j.meta && j.meta.domains_status) || {};
  const dg = (j.meta && j.meta.domains_suggestion) || {};
  function bulletize(s){ if(!s) return ''; return esc(s).split('\\n').map(x=>`<li>${x.replace(/^Â·\\s*/,'')}</li>`).join('');}
  domainsEl.innerHTML = ['äº‹ä¸š','æ„Ÿæƒ…'].map(k=>{
    return `<div class="section">
      <div class="badge">${k}</div>
      <div><b>è¿‘æœŸçŠ¶æ€</b><ul>${bulletize(ds[k])}</ul></div>
      <div><b>è¿‘æœŸå»ºè®®</b><ul>${bulletize(dg[k])}</ul></div>
    </div>`;
  }).join('');

  // åŸå§‹
  rawEl.textContent = JSON.stringify(j, null, 2);
}
</script>
</body>
</html>
