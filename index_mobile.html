<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>Selfy AIï¼ˆç§»åŠ¨ç‰ˆï¼‰</title>
  <style>
    :root { --bg:#0b0b0f; --card:#12121a; --muted:#8a8fa3; --text:#e9ebf1; --brand:#7aa2ff; --line: rgba(255,255,255,0.08); }
    * { box-sizing: border-box; }
    body { margin:0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "PingFang SC", "Hiragino Sans GB", "Microsoft Yahei", system-ui, sans-serif; background:var(--bg); color:var(--text); }
    header { padding:14px 16px; position:sticky; top:0; background:linear-gradient(180deg,#0b0b0f,rgba(11,11,15,0.6)); backdrop-filter: blur(6px); border-bottom:1px solid rgba(255,255,255,0.06); z-index:10; }
    h1 { font-size:18px; margin:0; letter-spacing: .5px; }
    main { padding:14px 16px 32px; max-width:720px; margin:0 auto; }
    .uploader { display:flex; gap:10px; align-items:center; margin:10px 0 18px; flex-wrap:wrap; }
    input[type=file] { display:none }
    .btn { background:#1a1b25; color:#e9ebf1; padding:10px 14px; border-radius:12px; border:1px solid var(--line); font-size:14px; }
    .btn:active { transform: scale(.98) }
    .btn.primary { background: linear-gradient(135deg,#3b82f6,#06b6d4); border:none; }
    .btn[disabled] { opacity:.6; pointer-events:none }
    .card { background:var(--card); border:1px solid var(--line); border-radius:16px; padding:14px; margin:12px 0; box-shadow: 0 6px 18px rgba(0,0,0,.25); }
    .title { font-weight:700; margin-bottom:8px; font-size:15px; }
    .muted { color: var(--muted); font-size:13px; }
    .grid { display:grid; grid-template-columns:1fr; gap:10px; }
    .kv { display:flex; gap:8px; font-size:14px; line-height:1.5; }
    .kv b { width:64px; color:#aeb6d9 }
    .bullets { display:flex; flex-wrap:wrap; gap:6px; margin-top:6px; }
    .pill { background:#161722; border:1px solid var(--line); padding:6px 8px; border-radius:999px; font-size:12px; color:#c9d1ff }
    .hr { height:1px; background:rgba(255,255,255,0.06); margin:10px -14px; }
    img.preview { width:100%; border-radius:12px; margin:10px 0; border:1px solid var(--line); }
    table { width: 100%; border-collapse: collapse; margin-top: 6px; }
    th, td { text-align:left; padding:8px 6px; border-bottom:1px solid var(--line); font-size:13px; }
    .tag { display:inline-block; padding:2px 8px; border-radius:999px; border:1px solid var(--line); background:#0f1120; color:#c9d1ff; font-size:12px; margin-right:6px; }
    details { background:#0f1120; border:1px solid var(--line); border-radius:12px; padding:10px; }
    details summary { cursor:pointer }
    /* Overlay */
    .overlay { position: fixed; inset: 0; background: rgba(0,0,0,.55); display:none; align-items:center; justify-content:center; z-index: 999; }
    .panel { background:#0f1120; border:1px solid var(--line); border-radius:16px; padding:18px 22px; text-align:center; box-shadow: 0 10px 30px rgba(0,0,0,.35); }
    .loader { width:48px; height:48px; border-radius:50%; border:4px solid rgba(122,162,255,.25); border-top-color:#7aa2ff; animation:spin 1.1s linear infinite; margin:0 auto 10px; }
    @keyframes spin { to { transform: rotate(360deg) } }
    .dots::after { content:""; animation:dots 1.2s steps(3,end) infinite; }
    @keyframes dots { 0%{content:""} 33%{content:"."} 66%{content:".."} 100%{content:"..."} }
    .status { font-size:13px; color:var(--muted); }
  </style>
</head>
<body>
  <header>
    <h1>Selfy AIï¼ˆç§»åŠ¨ç‰ˆï¼‰</h1>
  </header>
  <main>
    <div class="uploader">
      <label class="btn" for="file" id="chooseBtn">é€‰æ‹©å›¾ç‰‡</label>
      <input id="file" type="file" accept="image/*" />
      <button id="shot" class="btn">æ‹ç…§</button>
      <button id="analyze" class="btn primary" disabled>åˆ†æ</button>
      <span id="hint" class="muted">å…ˆé€‰æ‹©å›¾ç‰‡ï¼Œå†ç‚¹å‡»â€œåˆ†æâ€</span>
    </div>
    <img id="preview" class="preview" style="display:none"/>
    <div id="toast" class="muted"></div>
    <div id="out"></div>
  </main>

  <div id="overlay" class="overlay" role="dialog" aria-live="polite" aria-label="åˆ†æä¸­">
    <div class="panel">
      <div class="loader"></div>
      <div><b>è±¡æ•°åˆ†æä¸­</b><span class="dots"></span></div>
      <div class="status" id="overlayStatus">æ­£åœ¨ä¸Šä¼ ä¸æ¨ç†ï¼Œè¯·ç¨å€™</div>
    </div>
  </div>

  <script>
  // Elements
  const fileInput = document.getElementById('file');
  const chooseBtn = document.getElementById('chooseBtn');
  const shotBtn = document.getElementById('shot');
  const analyzeBtn = document.getElementById('analyze');
  const preview = document.getElementById('preview');
  const out = document.getElementById('out');
  const toast = document.getElementById('toast');
  const overlay = document.getElementById('overlay');
  const overlayStatus = document.getElementById('overlayStatus');

  // Camera trigger
  shotBtn.addEventListener('click', () => {
    fileInput.setAttribute('capture','environment');
    fileInput.click();
  });
  chooseBtn.addEventListener('click', () => {
    fileInput.removeAttribute('capture');
  });

  // After picking image
  fileInput.addEventListener('change', () => {
    const f = fileInput.files && fileInput.files[0];
    if(!f){ return; }
    const url = URL.createObjectURL(f);
    preview.src = url;
    preview.style.display = 'block';
    analyzeBtn.disabled = false;
    toast.textContent = `å·²é€‰æ‹©ï¼š${f.name || 'å›¾ç‰‡'}ï¼ˆ${Math.round((f.size||0)/1024)} KBï¼‰`;
  });

  // Analyze flow
  analyzeBtn.addEventListener('click', async () => {
    const f = fileInput.files && fileInput.files[0];
    if(!f){
      toast.textContent = 'è¯·å…ˆé€‰æ‹©å›¾ç‰‡';
      return;
    }
    try {
      setLoading(true, 'æ­£åœ¨ä¸Šä¼ å›¾ç‰‡â€¦');
      const fd = new FormData();
      fd.append('file', f, f.name || 'image.jpg');

      // Add a timeout to avoid hanging forever
      const controller = new AbortController();
      const timer = setTimeout(()=>controller.abort(), 90000); // 90s
      const res = await fetch('/upload', { method:'POST', body: fd, signal: controller.signal });
      clearTimeout(timer);

      setLoading(true, 'æ­£åœ¨è¿›è¡Œè±¡æ•°æ¨æ¼”â€¦');

      const text = await res.text();
      if(!res.ok){
        throw new Error(`HTTP ${res.status}: ${text.slice(0,200)}`);
      }
      try {
        const data = JSON.parse(text);
        render(data);
        toast.textContent = 'åˆ†æå®Œæˆ';
      } catch(e){
        showRaw(text, 'è¿”å›é JSONï¼Œå·²æ˜¾ç¤ºåŸæ–‡');
      }
    } catch(err){
      out.innerHTML = `<div class="card">å‡ºé”™ï¼š${escapeHtml(err && err.message || String(err))}</div>`;
      toast.textContent = 'åˆ†æå¤±è´¥';
    } finally {
      setLoading(false);
    }
  });

  function setLoading(on, status){
    overlay.style.display = on ? 'flex' : 'none';
    if(status) overlayStatus.textContent = status;
    analyzeBtn.disabled = on;
    chooseBtn.disabled = on;
    shotBtn.disabled = on;
  }

  // --- Rendering (same as previous tailored version) ---
  function pct(n){ try{ return Math.round((n||0)*100); }catch(e){ return 0; } }
  function safe(v){ return (v===0 || !!v)? String(v): '-'; }
  function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;",""":"&quot;","'":"&#39;"}[c])); }
  function toPills(text){
    if(!text) return [];
    const parts = String(text).split(/[ï¼›;ã€‚]/).map(s=>s.trim()).filter(Boolean);
    return parts.slice(0,8);
  }
  function cardBullets(title, items){
    return `<div class="card"><div class="title">${title}</div><div class="bullets">${
      items.map(x=>`<span class="pill">${escapeHtml(x)}</span>`).join('')
    }</div></div>`;
  }
  function showRaw(text, note){
    out.innerHTML = `<div class="card"><div class="title">åŸå§‹è¿”å›</div><div class="muted">${escapeHtml(note||'')}</div><details><summary>å±•å¼€</summary><pre style="white-space:pre-wrap">${escapeHtml(text)}</pre></details></div>`;
  }

  function render(d){
    const sec = d.sections || {};
    const meta = d.meta || {};
    const yi = meta.yi || {};
    const cb = meta.confidence_breakdown || {};
    const domDetail = meta.domains_detail || {};
    const domStatus = meta.domains_status || {};
    const faceParts = meta.face_parts || {};

    const headline = `
      <div class="card">
        <div class="title">æ€»è§ˆ</div>
        <div style="font-size:16px; margin:6px 0 2px;">äººæ ¼ç”»åƒï¼š${escapeHtml(d.archetype || 'â€”')}</div>
        <div class="muted">å¯ä¿¡åº¦ ${pct(d.confidence)}%
          ${cb['å›¾åƒæ¸…æ™°åº¦']!=null? ' Â· æ¸…æ™°åº¦ '+pct(cb['å›¾åƒæ¸…æ™°åº¦'])+'%':''}
          ${cb['å¦è±¡ä¸€è‡´æ€§']!=null? ' Â· å¦è±¡ä¸€è‡´æ€§ '+pct(cb['å¦è±¡ä¸€è‡´æ€§'])+'%':''}
        </div>
        <div class="hr"></div>
        <div class="kv"><b>Summary</b><span>${escapeHtml(d.summary||'â€”')}</span></div>
        <div class="kv"><b>Domains</b><span>${(d.domains||[]).map(x=>'<span class="tag">'+escapeHtml(x)+'</span>').join(' ')}</span></div>
      </div>`;

    function triCard(name, key){
      return `<div class="card"><div class="title">${name}</div>
        <div class="kv"><b>è§£è¯»</b><span>${escapeHtml(sec[key]||'â€”')}</span></div>
      </div>`;
    }
    const tri = `
      <div class="grid">
        ${triCard('ğŸ§ å§¿æ€','å§¿æ€')}
        ${triCard('ğŸ™‚ ç¥æƒ…','ç¥æƒ…')}
        ${triCard('ğŸ‘¤ é¢ç›¸','é¢ç›¸')}
      </div>`;

    // å…­çˆ»è¡¨
    let sixTable = '';
    const six = Array.isArray(meta.six_yao)? meta.six_yao.slice().sort((a,b)=>(a.position||0)-(b.position||0)) : [];
    if(six.length){
      sixTable = `<div class="card"><div class="title">å…­çˆ»</div>
        <table><thead><tr><th>ä½</th><th>éƒ¨ä½</th><th>é˜´é˜³</th><th>åŠ¨çˆ»</th><th>åˆ†å€¼</th></tr></thead>
        <tbody>${six.map(r=>'<tr><td>'+safe(r.position)+'</td><td>'+escapeHtml(r.feature||'')+'</td><td>'+escapeHtml(r.yin_yang||'')+'</td><td>'+(r.moving?'âœ…':'')+'</td><td>'+safe(r.score)+'</td></tr>').join('')}</tbody>
        </table></div>`;
    }

    // å¦è±¡åŒºåŸŸ
    let yiCard = '';
    if(yi.trigrams || yi.hexagram){
      const u = yi.trigrams?.upper || {}, l = yi.trigrams?.lower || {};
      yiCard = `<div class="card"><div class="title">å¦è±¡</div>
        <div class="kv"><b>ä¸Šå¦</b><span>${escapeHtml(u.name||'-')}</span></div>
        <div class="kv"><b>ä¸‹å¦</b><span>${escapeHtml(l.name||'-')}</span></div>
        ${yi.hexagram? `<div class="kv"><b>æœ¬å¦</b><span>#${safe(yi.hexagram.king_wen_no)} ${escapeHtml(yi.hexagram.name||'')}</span></div>`:''}
        ${Array.isArray(yi.hexagram?.moving_lines)? `<div class="kv"><b>åŠ¨çˆ»</b><span>${yi.hexagram.moving_lines.join(', ')||'-'}</span></div>`:''}
        ${yi.derived_hexagram? `<div class="kv"><b>ä¹‹å¦</b><span>#${safe(yi.derived_hexagram.king_wen_no)} ${escapeHtml(yi.derived_hexagram.name||'')}</span></div>`:''}
      </div>`;
    }

    // é¢†åŸŸè¦ç‚¹ï¼ˆæ–°ç‰ˆä¼˜å…ˆï¼‰
    function assembleDomain(keyCN, keyOld){
      const status = (domStatus[keyCN] || '').trim();
      const suggest = (meta.domains_suggestion && meta.domains_suggestion[keyCN]) || '';
      let text = (status? status+'ï¼›' : '') + (suggest || '');
      if(!text) text = domDetail[keyOld] || '';
      const pills = toPills(text);
      return pills.length ? cardBullets((keyCN==='äº‹ä¸š'?'ğŸ’¼ ':'ğŸ’— ')+keyCN+'ï½œè¿‘æœŸè¦ç‚¹', pills) : '';
    }
    const domCards = assembleDomain('äº‹ä¸š','é‡‘é’±ä¸äº‹ä¸š') + assembleDomain('æ„Ÿæƒ…','é…å¶ä¸æ„Ÿæƒ…');

    // äº”å®˜ç»†èŠ‚
    let faceCard = '';
    const keys = Object.keys(faceParts||{});
    if(keys.length){
      faceCard = '<div class="card"><div class="title">äº”å®˜ç»†èŠ‚</div><table><thead><tr><th>éƒ¨ä½</th><th>ç‰¹å¾</th><th>å¦è±¡</th><th>è§£è¯»</th></tr></thead><tbody>'
        + keys.map(k=>{
          const it = faceParts[k]||{};
          return '<tr><td>'+escapeHtml(k)+'</td><td>'+escapeHtml(it['ç‰¹å¾']||'')+'</td><td>'+escapeHtml(it['å¦è±¡']||'')+'</td><td>'+escapeHtml(it['è§£è¯»']||'')+'</td></tr>';
        }).join('') + '</tbody></table></div>';
    }

    // åŸå§‹ JSON
    const raw = `<details class="card"><summary>åŸå§‹ JSON</summary><pre style="white-space:pre-wrap">${escapeHtml(JSON.stringify(d,null,2))}</pre></details>`;

    out.innerHTML = headline + tri + yiCard + sixTable + domCards + faceCard + raw;
  }
  </script>
</body>
</html>
