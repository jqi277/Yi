<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Selfy AI — 移动上传</title>
<style>
:root{--bg:#0f1115;--card:#171923;--text:#e6eaf2;--muted:#a9b1c7;--accent:#7aa2f7;--ok:#10b981;--err:#ef4444;}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Inter,"PingFang SC","Hiragino Sans GB","Microsoft YaHei",sans-serif}
.container{max-width:720px;margin:0 auto;padding:24px}
.card{background:var(--card);border-radius:16px;box-shadow:0 10px 26px rgba(0,0,0,.35);padding:20px}
h1{font-size:20px;margin:0 0 12px}
p{color:var(--muted);margin:8px 0 16px}
.uploader{display:flex;gap:10px;align-items:center}
input[type=file]{flex:1;padding:10px;border:1px dashed #3a4052;border-radius:12px;background:#10131a;color:var(--muted)}
button{padding:10px 14px;border:0;border-radius:12px;background:var(--accent);color:#0b1020;font-weight:600;cursor:pointer}
button:disabled{opacity:.55;cursor:not-allowed}
#imgPreview{margin-top:12px;border-radius:12px;max-width:100%}
.hr{height:1px;background:#242938;margin:18px 0}
#status{font-size:13px;color:var(--muted)}
.badge{display:inline-block;padding:2px 8px;border-radius:999px;background:#1f2433;color:#aab4d4;border:1px solid #2a2f42;font-size:12px}
.grid{display:grid;grid-template-columns:1fr;gap:12px}
.section{padding:12px;border:1px solid #262b3e;border-radius:12px;background:#121624}
.section h3{margin:0 0 6px;font-size:15px}
pre{white-space:pre-wrap;word-break:break-word;background:#0f1320;padding:12px;border-radius:10px;color:#d7e0ff;overflow:auto;max-height:300px}
.small{font-size:12px;color:#95a1c7}
</style>
</head>
<body>
<div class="container">
  <div class="card">
    <h1>📸 Selfy AI — YiJing Inference</h1>
    <p>上传一张人像，返回 <span class="badge">姿态/神情/面相</span> 与 <span class="badge">卦象组合</span>，并生成事业/感情的近期状态与建议。</p>
    <div class="uploader">
      <input id="file" type="file" accept="image/*">
      <button id="btn" disabled>上传分析</button>
    </div>
    <img id="imgPreview" hidden />
    <div class="hr"></div>
    <div id="status">就绪。</div>
    <div class="hr"></div>
    <div class="grid" id="result" hidden>
      <div class="section">
        <h3>概览</h3>
        <div id="overview"></div>
      </div>
      <div class="section">
        <h3>三象四段式</h3>
        <div id="triple"></div>
      </div>
      <div class="section">
        <h3>事业 / 感情</h3>
        <div id="domains"></div>
      </div>
      <div class="section">
        <h3>原始 JSON</h3>
        <pre id="raw"></pre>
        <div class="small">如需调试，可复制此 JSON 到本地查看。</div>
      </div>
    </div>
  </div>
</div>
<script>
const fileEl = document.getElementById('file');
const btnEl = document.getElementById('btn');
const imgEl = document.getElementById('imgPreview');
const statusEl = document.getElementById('status');
const resultEl = document.getElementById('result');
const overviewEl = document.getElementById('overview');
const tripleEl = document.getElementById('triple');
const domainsEl = document.getElementById('domains');
const rawEl = document.getElementById('raw');

fileEl.addEventListener('change', () => {
  btnEl.disabled = !fileEl.files.length;
  if (fileEl.files && fileEl.files[0]) {
    const url = URL.createObjectURL(fileEl.files[0]);
    imgEl.src = url; imgEl.hidden = false;
  }
});

btnEl.addEventListener('click', async () => {
  if (!fileEl.files.length) return;
  btnEl.disabled = true;
  statusEl.textContent = '上传中…';
  try {
    const form = new FormData();
    form.append('file', fileEl.files[0]);
    const r = await fetch('/upload', { method: 'POST', body: form });
    if (!r.ok) {
      const t = await r.text();
      throw new Error('HTTP ' + r.status + ' ' + t);
    }
    const data = await r.json();
    renderResult(data);
    statusEl.textContent = '完成。';
  } catch (e) {
    console.error(e);
    statusEl.innerHTML = '<span style="color:var(--err)">失败：</span>' + e.message;
  } finally {
    btnEl.disabled = false;
  }
});

function esc(s){return (s??'').toString().replace(/[&<>"]/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]))}

function renderResult(j){
  resultEl.hidden = false;
  // 概览卡
  const oc = (j.meta && j.meta.overview_card) || {};
  const head = (j.meta && j.meta.headline) || {};
  const tag = esc(head.tag||j.archetype||'');
  const conf = (head.confidence!=null)?(' · 置信度 '+Number(head.confidence).toFixed(2)) : '';
  overviewEl.innerHTML = `<div class="badge">${esc(oc.title||'卦象组合')}</div>
  <p>${esc(oc.summary||'')}</p>
  <div class="small">archetype: <b>${tag}</b>${conf}</div>`;

  // 三象四段式
  const ta = (j.meta && j.meta.triple_analysis) || {};
  const parts = ['姿态','神情','面相'];
  tripleEl.innerHTML = parts.map(k=>{
    const o = ta[k]||{};
    const gx = esc(o['卦象']||'');
    const jd = esc(o['解读']||'');
    const xg = esc(o['性格倾向']||'');
    return `<div class="section">
      <div class="badge">${k}</div>
      <div>卦象：<b>${gx}</b></div>
      <div style="margin-top:4px">${jd}</div>
      <div class="small" style="margin-top:6px">${xg}</div>
    </div>`;
  }).join('');

  // 事业/感情
  const ds = (j.meta && j.meta.domains_status) || {};
  const dg = (j.meta && j.meta.domains_suggestion) || {};
  function bulletize(s){ if(!s) return ''; return esc(s).split('\\n').map(x=>`<li>${x.replace(/^·\\s*/,'')}</li>`).join('');}
  domainsEl.innerHTML = ['事业','感情'].map(k=>{
    return `<div class="section">
      <div class="badge">${k}</div>
      <div><b>近期状态</b><ul>${bulletize(ds[k])}</ul></div>
      <div><b>近期建议</b><ul>${bulletize(dg[k])}</ul></div>
    </div>`;
  }).join('');

  // 原始
  rawEl.textContent = JSON.stringify(j, null, 2);
}
</script>
</body>
</html>
