<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>Selfy AI（移动版）</title>
  <style>
    :root{
      --bg:#f6f7fb; --text:#101423; --muted:#5c647a; --line:#e5e7ef;
      --card:#ffffff; --brand1:#6da8ff; --brand2:#6de4c1; --brand3:#8b7dff;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"PingFang SC","Hiragino Sans GB","Microsoft Yahei",system-ui,sans-serif}
    header{
      position:sticky;top:0;z-index:20;
      background:linear-gradient(180deg,#fff,rgba(255,255,255,.6));
      border-bottom:1px solid var(--line);
      padding:14px 16px
    }
    h1{font-size:18px;margin:0;letter-spacing:.2px}
    main{padding:16px;max-width:760px;margin:0 auto}
    .bar{
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:12px 0 18px
    }
    .btn{appearance:none;-webkit-appearance:none;border:none;cursor:pointer;
      background:#fff;color:var(--text);padding:10px 14px;border-radius:12px;
      border:1px solid var(--line);box-shadow:0 2px 10px rgba(16,20,35,.06);font-size:14px}
    .btn.primary{
      background:linear-gradient(135deg,var(--brand1),var(--brand2),var(--brand3));
      color:#fff;border:none;box-shadow:0 6px 18px rgba(109,168,255,.35)
    }
    .btn[disabled]{opacity:.55;cursor:not-allowed}
    .hint{color:var(--muted);font-size:13px}
    .card{
      background:var(--card);border:1px solid var(--line);border-radius:16px;padding:14px;
      margin:12px 0;box-shadow:0 6px 24px rgba(16,20,35,.06)
    }
    .title{font-weight:700;margin-bottom:8px;font-size:15px}
    .kv{display:flex;gap:8px;line-height:1.6}
    .kv b{width:64px;color:#6b738e;font-weight:600}
    .grid{display:grid;grid-template-columns:1fr;gap:10px}
    .pill{display:inline-block;background:#f2f5ff;border:1px solid #dbe3ff;color:#3451e0;
          padding:6px 10px;border-radius:999px;font-size:12px;margin:3px 6px 0 0}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{border-bottom:1px solid var(--line);padding:8px 6px;text-align:left;font-size:13px}
    .muted{color:var(--muted)}
    img.preview{width:100%;border-radius:14px;border:1px solid var(--line);display:none}
    details{background:#fbfbfe;border:1px solid var(--line);border-radius:12px;padding:10px}
    details summary{cursor:pointer}
    /* Loading overlay */
    .overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;
      background:rgba(16,20,35,.45);backdrop-filter:saturate(120%) blur(6px);z-index:9999;pointer-events:none}
    .panel{pointer-events:auto;background:#fff;border-radius:16px;border:1px solid var(--line);padding:18px 22px;min-width:240px;text-align:center;
      box-shadow:0 10px 30px rgba(16,20,35,.18)}
    .loader{width:48px;height:48px;border-radius:50%;border:4px solid rgba(109,168,255,.25);border-top-color:#6da8ff;animation:spin 1.1s linear infinite;margin:0 auto 10px}
    @keyframes spin{to{transform:rotate(360deg)}}
    .dots::after{content:"";animation:dots 1.2s steps(3,end) infinite}
    @keyframes dots{0%{content:""}33%{content:"."}66%{content:".."}100%{content:"..."}}
    /* Simple toast */
    .toast{position:fixed;left:50%;bottom:24px;transform:translateX(-50%);background:#101423;color:#fff;padding:8px 12px;border-radius:10px;opacity:0;transition:.25s}
    .toast.show{opacity:1}
  </style>
</head>
<body>
  <header>
    <h1>Selfy AI（移动版）</h1>
  </header>
  <main>
    <div class="bar">
      <label class="btn" for="file" id="chooseBtn">选择图片</label>
      <input id="file" type="file" accept="image/*" />
      <button id="shot" class="btn" type="button">拍照</button>
      <button id="analyze" class="btn primary" type="button" disabled>分析</button>
      <span id="hint" class="hint">先选择图片，再点击“分析”</span>
    </div>
    <img id="preview" class="preview"/>
    <div id="out"></div>
  </main>

  <div id="overlay" class="overlay" aria-live="polite" aria-label="象数分析中">
    <div class="panel">
      <div class="loader"></div>
      <div><b>象数分析中</b><span class="dots"></span></div>
      <div id="ol-status" class="muted" style="margin-top:4px">正在上传与推理</div>
    </div>
  </div>
  <div id="toast" class="toast"></div>

  <script>
  const $ = sel => document.querySelector(sel);
  const fileInput = $('#file'), chooseBtn=$('#chooseBtn'), shotBtn=$('#shot'), analyzeBtn=$('#analyze');
  const preview=$('#preview'), out=$('#out'), overlay=$('#overlay'), olStatus=$('#ol-status'), toast=$('#toast');

  // Camera capture toggle
  shotBtn.addEventListener('click', () => { fileInput.setAttribute('capture','environment'); fileInput.click(); });
  chooseBtn.addEventListener('click', () => { fileInput.removeAttribute('capture'); });

  // Enable "分析" when a file is selected, always remove the disabled attr explicitly
  fileInput.addEventListener('change', () => {
    const f = fileInput.files && fileInput.files[0];
    if (!f) return;
    preview.src = URL.createObjectURL(f);
    preview.style.display = 'block';
    analyzeBtn.disabled = false;
    analyzeBtn.removeAttribute('disabled'); // iOS 某些机型对 disabled 需要显式移除
    hint('已选择：' + (f.name || '图片') + ' · ' + Math.round((f.size||0)/1024) + 'KB');
  });

  analyzeBtn.addEventListener('click', async () => {
    const f = fileInput.files && fileInput.files[0];
    if (!f) { hint('请先选择图片'); return; }
    setLoading(true, '正在上传图片…');
    try{
      const fd = new FormData(); fd.append('file', f, f.name || 'image.jpg');
      const controller = new AbortController(); const timer = setTimeout(()=>controller.abort(), 120000);
      const res = await fetch('/upload', { method:'POST', body: fd, signal: controller.signal });
      clearTimeout(timer);
      setLoading(true, '正在进行象数推演…');
      const text = await res.text();
      if(!res.ok) throw new Error('HTTP '+res.status+': '+text.slice(0,200));
      let data;
      try{ data = JSON.parse(text); }catch(e){ showRaw(text, '返回非 JSON'); return; }
      render(data); hint('分析完成');
    }catch(err){
      out.innerHTML = '<div class="card"><div class="title">出错</div><div class="muted">'+escapeHtml(err.message||String(err))+'</div></div>';
      hint('分析失败');
    }finally{
      setLoading(false);
    }
  });

  function setLoading(on, status){
    overlay.style.display = on ? 'flex' : 'none';
    if(status) olStatus.textContent = status;
    if(on){
      overlay.style.pointerEvents='auto';
      analyzeBtn.setAttribute('disabled','true');
      chooseBtn.setAttribute('aria-disabled','true');
      shotBtn.setAttribute('disabled','true');
    }else{
      overlay.style.pointerEvents='none';
      analyzeBtn.removeAttribute('disabled');
      chooseBtn.removeAttribute('aria-disabled');
      shotBtn.removeAttribute('disabled');
    }
  }

  function render(d){
    const sec = d.sections || {};
    const meta = d.meta || {};
    const yi = meta.yi || {};
    const domStatus = meta.domains_status || {};
    const domDetail = meta.domains_detail || {};
    const faceParts = meta.face_parts || {};

    const header = `
      <div class="card">
        <div class="title">总览</div>
        <div class="kv"><b>画像</b><span>${escapeHtml(d.archetype||'—')}</span></div>
        <div class="kv"><b>Summary</b><span>${escapeHtml(d.summary||'—')}</span></div>
        <div class="kv"><b>Domains</b><span>${(d.domains||[]).map(x=>'<span class="pill">'+escapeHtml(x)+'</span>').join(' ')}</span></div>
      </div>`;

    const tri = `
      <div class="grid">
        ${triCard('🧍 姿态','姿态', sec)}
        ${triCard('🙂 神情','神情', sec)}
        ${triCard('👤 面相','面相', sec)}
      </div>`;

    let six = Array.isArray(meta.six_yao)? meta.six_yao.slice().sort((a,b)=>(a.position||0)-(b.position||0)) : [];
    const sixTbl = six.length? `
      <div class="card">
        <div class="title">六爻</div>
        <table class="table">
          <thead><tr><th>位</th><th>部位</th><th>阴阳</th><th>动爻</th><th>分值</th></tr></thead>
          <tbody>${six.map(r=>'<tr><td>'+safe(r.position)+'</td><td>'+escapeHtml(r.feature||'')+'</td><td>'+escapeHtml(r.yin_yang||'')+'</td><td>'+(r.moving?'✅':'')+'</td><td>'+safe(r.score)+'</td></tr>').join('')}</tbody>
        </table>
      </div>` : '';

    const yiCard = (yi.trigrams||yi.hexagram)? `
      <div class="card">
        <div class="title">卦象</div>
        <div class="kv"><b>上卦</b><span>${escapeHtml(yi.trigrams?.upper?.name||'-')}</span></div>
        <div class="kv"><b>下卦</b><span>${escapeHtml(yi.trigrams?.lower?.name||'-')}</span></div>
        ${yi.hexagram? '<div class="kv"><b>本卦</b><span>#'+safe(yi.hexagram.king_wen_no)+' '+escapeHtml(yi.hexagram.name||'')+'</span></div>':''}
        ${Array.isArray(yi.hexagram?.moving_lines)? '<div class="kv"><b>动爻</b><span>'+yi.hexagram.moving_lines.join(', ')+'</span></div>':''}
        ${yi.derived_hexagram? '<div class="kv"><b>之卦</b><span>#'+safe(yi.derived_hexagram.king_wen_no)+' '+escapeHtml(yi.derived_hexagram.name||'')+'</span></div>':''}
      </div>` : '';

    const biz = toPills((domStatus['事业']? domStatus['事业']+'；':'') + (meta.domains_suggestion?.['事业']||'') || domDetail['金钱与事业']);
    const rel = toPills((domStatus['感情']? domStatus['感情']+'；':'') + (meta.domains_suggestion?.['感情']||'') || domDetail['配偶与感情']);
    const domainCards = `
      ${biz.length? cardBullets('💼 事业｜近期要点', biz): ''}
      ${rel.length? cardBullets('💗 感情｜近期要点', rel): ''}
    `;

    let faceCard='';
    const keys = Object.keys(faceParts||{});
    if(keys.length){
      faceCard = '<div class="card"><div class="title">五官细节</div><table class="table"><thead><tr><th>部位</th><th>特征</th><th>卦象</th><th>解读</th></tr></thead><tbody>'
        + keys.map(k=>{
          const it = faceParts[k]||{};
          return '<tr><td>'+escapeHtml(k)+'</td><td>'+escapeHtml(it['特征']||'')+'</td><td>'+escapeHtml(it['卦象']||'')+'</td><td>'+escapeHtml(it['解读']||'')+'</td></tr>';
        }).join('') + '</tbody></table></div>';
    }

    const raw = '<details class="card"><summary>原始 JSON</summary><pre style="white-space:pre-wrap">'+escapeHtml(JSON.stringify(d,null,2))+'</pre></details>';

    out.innerHTML = header + tri + yiCard + sixTbl + domainCards + faceCard + raw;
    window.scrollTo({top: preview.offsetTop, behavior: 'smooth'});
  }

  function triCard(title, key, sec){
    return '<div class="card"><div class="title">'+title+'</div><div class="kv"><b>解读</b><span>'+escapeHtml(sec[key]||'—')+'</span></div></div>';
  }

  function toPills(text){
    if(!text) return [];
    return String(text).split(/[；;。]/).map(s=>s.trim()).filter(Boolean).slice(0,8);
  }
  function safe(v){ return (v===0 || !!v)? String(v):'-'; }
  function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

  function hint(msg){
    toast.textContent = msg;
    toast.classList.add('show');
    setTimeout(()=>toast.classList.remove('show'), 1600);
  }
  </script>
</body>
</html>
