<script>
const SYMBOLS = {"艮":"山","离":"火","兑":"泽","乾":"天","坤":"地","震":"雷","巽":"风","坎":"水"};

const fileInput = document.getElementById('file');
const shotBtn = document.getElementById('shot');
const out = document.getElementById('out');
const preview = document.getElementById('preview');

shotBtn.addEventListener('click', () => { fileInput.setAttribute('capture','environment'); fileInput.click(); });
document.querySelector('label[for=file]').addEventListener('click', () => { fileInput.removeAttribute('capture'); });

fileInput.addEventListener('change', async (e) => {
  const f = e.target.files[0];
  if (!f) return;
  const url = URL.createObjectURL(f);
  preview.src = url; preview.style.display = 'block';
  out.innerHTML = '<div class="card loading">分析中…</div>';

  const fd = new FormData(); fd.append('file', f, f.name || 'image.jpg');
  try {
    const r = await fetch('/upload', { method: 'POST', body: fd });
    if (!r.ok) throw new Error('HTTP '+r.status);
    const data = await r.json();
    render(data);
  } catch (err) {
    out.innerHTML = `<div class="card">出错了：${(err && err.message) || err}</div>`;
  }
});

function pct(n){ try{ return Math.round(n*100); }catch(e){ return 0; } }
function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])); }

function render(d){
  const ta   = d.meta?.triple_analysis || {};
  const cb   = d.meta?.confidence_breakdown || {};
  const fps  = d.meta?.face_parts || {};
  const stat = d.meta?.domains_status_text || {};
  const sugg = d.meta?.domains_suggestion_text || {};

  // 头卡：只露出“图片清晰度”
  const headline = `
    <div class="card">
      <div class="title">Selfy AI</div>
      <div style="font-size:16px; margin:6px 0 2px;">人格画像：${escapeHtml(d.archetype || '—')}</div>
      <div class="muted">图片清晰度 ${pct(cb['图像清晰度']||0)}%</div>
    </div>`;

  function triCard(name, key){
    const o = ta[key] || {};
    let hex = o['卦象'] || '';
    // 面相缺卦时由后端已回填，不再前端推断
    const sym = SYMBOLS[hex]||'';
    const rows = [
      `<div class="kv"><b>卦象</b><span>${hex ? `${hex}卦（${sym}）` : '—'}</span></div>`,
      `<div class="kv"><b>解读</b><span>${escapeHtml(o['解读']||'—')}</span></div>`
    ];
    if (o['经文提示']) rows.push(`<div class="kv"><b>经文提示</b><span>${escapeHtml(o['经文提示'])}</span></div>`);

    // 在【面相】卡片内嵌“六官细节”（爻级别）
    if (key === '面容' && fps && Object.keys(fps).length){
      const items = Object.entries(fps).map(([part, info])=>{
        const f = info?.['特征'] || '';
        const h = (info?.['卦象'] || '').trim();
        const hs = h ? `${h}卦（${SYMBOLS[h]||''}）` : '—';
        const e = info?.['解读'] || '';
        return `<div class="kv"><b>${escapeHtml(part)}</b><span>${escapeHtml(f)}｜${hs}｜${escapeHtml(e)}</span></div>`;
      }).join('');
      rows.push(`<div class="hr"></div>` + items);
    }
    return `<div class="card"><div class="title">${name}</div>${rows.join('')}</div>`;
  }

  // 三分象一行（上传后显示）
  const tri = `
    <div class="grid">
      ${triCard('🧍 姿态','姿态')}
      ${triCard('🙂 神情','神情')}
      ${triCard('👤 面相','面容')}
    </div>`;

  // 八卦类比（文本换行）
  const combo = (()=>{
    const oc = d.meta?.overview_card || {};
    const text = (oc.summary||'').split('\n').map(ln=>escapeHtml(ln)).join('<br>');
    return `<div class="card"><div class="title">${escapeHtml(oc.title||'八卦类比')}</div><div class="para">${text}</div></div>`;
  })();

  // 事业/感情：句子版（去掉 pills）
  const domCards = (titleKey, s, g) => {
    const sTxt = (s||'').trim();
    const gTxt = (g||'').trim();
    if (!sTxt && !gTxt) return '';
    return `<div class="card">
      <div class="title">${titleKey}</div>
      ${sTxt ? `<div class="kv"><b>近期状态</b><span>${escapeHtml(sTxt)}</span></div>` : ''}
      ${gTxt ? `<div class="kv"><b>建议</b><span>${escapeHtml(gTxt)}</span></div>` : ''}
    </div>`;
  };

  out.innerHTML = headline + tri + combo +
                  domCards('💼 事业', stat['事业'], sugg['事业']) +
                  domCards('💗 感情', stat['感情'], sugg['感情']);
}
</script>
