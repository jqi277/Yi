<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Selfy AI Mobile · 结果展示</title>
<style>
  :root{--bg:#0b0f14;--panel:#111826;--fg:#e8eef7;--muted:#9fb3c8;--acc:#66a6ff;--line:#1f2937}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  header{padding:16px;border-bottom:1px solid var(--line);background:linear-gradient(180deg,rgba(102,166,255,.08),transparent)}
  main{padding:16px;max-width:1080px;margin:auto}
  .grid{display:grid;grid-template-columns:1fr;gap:12px}
  @media(min-width:900px){.grid{grid-template-columns:360px 1fr}}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:16px;box-shadow:0 6px 18px rgba(0,0,0,.25)}
  h1{font-size:20px;margin:0} h2{font-size:18px;margin:8px 0 8px}
  p{color:var(--muted);margin:.25rem 0 .75rem}
  code{background:#0f172a;padding:2px 6px;border-radius:6px;color:#cbd5e1}
  input[type=file]{width:100%;color:var(--fg)}
  button{padding:10px 14px;border-radius:10px;border:1px solid var(--line);background:#0f172a;color:var(--fg);cursor:pointer}
  button.primary{background:linear-gradient(135deg,#3b82f6,#06b6d4);border:none}
  .row{display:flex;gap:10px;align-items:center}
  .kv{display:grid;grid-template-columns:120px 1fr;gap:6px 12px}
  .tag{display:inline-block;background:#0f172a;border:1px solid var(--line);padding:2px 8px;border-radius:999px;font-size:12px;margin-right:6px}
  .muted{color:var(--muted)}
  table{width:100%;border-collapse:collapse}
  th,td{border-bottom:1px solid var(--line);padding:8px;text-align:left;font-size:14px}
  .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
  details{background:#0f172a;border:1px solid var(--line);border-radius:10px;padding:10px;margin-top:8px}
  .ok{color:#10b981}.warn{color:#f59e0b}.err{color:#ef4444}
</style>
</head>
<body>
  <header>
    <h1>Selfy AI Mobile</h1>
    <p class="muted">上传图片 → 调用 <code>POST /upload</code> → 结构化展示 + 原始 JSON</p>
  </header>
  <main class="grid">
    <div class="card">
      <h2>上传图片</h2>
      <p>选择文件后点击 <b>分析</b>。支持手机相册。</p>
      <div class="row">
        <input id="file" type="file" accept="image/*">
        <button id="btn" class="primary">分析</button>
      </div>
      <details style="margin-top:12px">
        <summary>高级选项</summary>
        <label><input type="checkbox" id="rawOnly"> 仅显示原始 JSON（不做渲染）</label><br>
        <label><input type="checkbox" id="pretty"> JSON 美化显示</label>
      </details>
      <div id="status" class="muted" style="margin-top:8px"></div>
    </div>

    <div class="card">
      <h2>结果</h2>
      <div id="view"></div>
      <details>
        <summary>原始 JSON</summary>
        <pre id="raw" class="mono">{ 提交图片后显示结果 }</pre>
      </details>
    </div>
  </main>

<script>
const el = s=>document.querySelector(s);
const pretty = obj=>JSON.stringify(obj,null, el('#pretty').checked?2:0);

function render(data){
  const v = el('#view');
  v.innerHTML = '';
  if(!data || typeof data !== 'object'){ v.innerHTML='<p class="err">解析失败</p>'; return; }
  const meta = data.meta || {};
  const yi = meta.yi || {};
  const sec = data.sections || {};
  const doms = meta.domains_status || {};
  const tips = meta.domains_suggestion || {};
  const faces = (meta.face_parts && typeof meta.face_parts==='object')? meta.face_parts : {};

  // 顶部摘要
  v.insertAdjacentHTML('beforeend', `
    <div class="kv" style="margin-bottom:12px">
      <div>Summary</div><div>${escapeHtml(data.summary||'')}</div>
      <div>Archetype</div><div><span class="tag">${escapeHtml(data.archetype||'-')}</span></div>
      <div>Confidence</div><div>${typeof data.confidence==='number'? data.confidence.toFixed(2):'-'}</div>
      <div>Domains</div><div>${(data.domains||[]).map(x=>'<span class="tag">'+escapeHtml(x)+'</span>').join(' ')}</div>
    </div>
  `);

  // 三象
  v.insertAdjacentHTML('beforeend', `
    <h3>三象解读</h3>
    <div class="kv">
      <div>姿态</div><div>${escapeHtml(sec['姿态']||'-')}</div>
      <div>神情</div><div>${escapeHtml(sec['神情']||'-')}</div>
      <div>面相</div><div>${escapeHtml(sec['面相']||'-')}</div>
    </div>
  `);

  // 六爻表
  const six = (meta.six_yao||[]).slice().sort((a,b)=>(a.position||0)-(b.position||0));
  if(six.length){
    v.insertAdjacentHTML('beforeend', `<h3 style="margin-top:14px">六爻</h3>
      <table><thead><tr><th>位</th><th>部位</th><th>阴阳</th><th>动爻</th><th>分值</th></tr></thead>
      <tbody>${six.map(r=>'<tr><td>'+safe(r.position)+'</td><td>'+escapeHtml(r.feature||'')+'</td><td>'+escapeHtml(r.yin_yang||'')+'</td><td>'+ (r.moving?'✅':'') +'</td><td>'+safe(r.score)+'</td></tr>').join('')}</tbody></table>`);
  }

  // 卦象
  if(yi.trigrams || yi.hexagram){
    v.insertAdjacentHTML('beforeend', `<h3 style="margin-top:14px">卦象</h3>`);
    if(yi.trigrams){
      const u = yi.trigrams.upper||{}, l = yi.trigrams.lower||{};
      v.insertAdjacentHTML('beforeend', `<p>上卦：<span class="tag">${escapeHtml(u.name||'-')}</span>　下卦：<span class="tag">${escapeHtml(l.name||'-')}</span></p>`);
    }
    if(yi.hexagram){
      v.insertAdjacentHTML('beforeend', `<div class="kv">
        <div>本卦</div><div>#${safe(yi.hexagram.king_wen_no)} ${escapeHtml(yi.hexagram.name||'')}</div>
        <div>动爻</div><div>${Array.isArray(yi.hexagram.moving_lines)? yi.hexagram.moving_lines.join(', '): '-'}</div>
      </div>`);
    }
    if(yi.derived_hexagram){
      v.insertAdjacentHTML('beforeend', `<div class="kv">
        <div>之卦</div><div>#${safe(yi.derived_hexagram.king_wen_no)} ${escapeHtml(yi.derived_hexagram.name||'')}</div>
      </div>`);
    }
  }

  // 领域建议
  if(doms['事业'] || doms['感情'] || tips['事业'] || tips['感情']){
    v.insertAdjacentHTML('beforeend', `<h3 style="margin-top:14px">领域建议</h3>`);
    if(doms['事业'] || tips['事业']) v.insertAdjacentHTML('beforeend', `<p><b>事业：</b>${escapeHtml((doms['事业']||'') + (tips['事业']? '；'+tips['事业'] : ''))}</p>`);
    if(doms['感情'] || tips['感情']) v.insertAdjacentHTML('beforeend', `<p><b>感情：</b>${escapeHtml((doms['感情']||'') + (tips['感情']? '；'+tips['感情'] : ''))}</p>`);
  }

  // 五官
  const faceKeys = Object.keys(faces);
  if(faceKeys.length){
    v.insertAdjacentHTML('beforeend', `<h3 style="margin-top:14px">五官细节</h3>`);
    let rows = '';
    faceKeys.forEach(k=>{
      const it = faces[k]||{};
      rows += '<tr><td>'+escapeHtml(k)+'</td><td>'+escapeHtml(it['特征']||'')+'</td><td>'+escapeHtml(it['卦象']||'')+'</td><td>'+escapeHtml(it['解读']||'')+'</td></tr>';
    });
    v.insertAdjacentHTML('beforeend', `<table><thead><tr><th>部位</th><th>特征</th><th>卦象</th><th>解读</th></tr></thead><tbody>${rows}</tbody></table>`);
  }
}

function safe(v){ return (v===0 || !!v)? String(v): '-'; }
function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

async function doUpload(){
  const btn = el('#btn'); const out = el('#raw'); const view = el('#view'); const stat = el('#status');
  const f = el('#file').files[0];
  if(!f){ alert('请选择图片'); return; }
  btn.disabled = true; btn.textContent = '处理中...'; stat.textContent = '';
  try{
    const fd = new FormData(); fd.append('file', f);
    const res = await fetch('/upload', { method:'POST', body: fd });
    const txt = await res.text();
    out.textContent = txt;
    if(el('#rawOnly').checked){ view.innerHTML = '<p class="warn">原始 JSON 模式已开启，不做渲染。</p>'; }
    else{
      try{ const json = JSON.parse(txt); render(json); }
      catch(e){ view.innerHTML = '<p class="err">JSON 解析失败：'+e.message+'</p>'; }
    }
    stat.textContent = res.ok ? '✅ 成功' : ('❌ ' + res.status);
  }catch(err){
    view.innerHTML = '<p class="err">请求出错：'+err.message+'</p>';
    out.textContent = String(err);
    stat.textContent = '❌ 出错';
  }finally{
    btn.disabled = false; btn.textContent = '分析';
  }
}

document.addEventListener('click', e=>{ if(e.target && e.target.id==='btn') doUpload(); });
</script>
</body>
</html>
