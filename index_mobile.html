<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <title>Selfy AI â€” æ˜“ç»è§‚ç›¸ï¼ˆç§»åŠ¨ç‰ˆï¼‰</title>
  <script>window.API_BASE = location.origin || "http://127.0.0.1:10000";</script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body{background:radial-gradient(900px 540px at 50% -180px,#f8fafc 0%,#f1f5f9 60%,#e5e7eb 100%);}
    .card{background:#fff;border-radius:16px;box-shadow:0 8px 24px rgba(0,0,0,.06);padding:16px;}
    #overviewLead{white-space:pre-line;}
    .pill{display:inline-flex;padding:.25rem .6rem;border-radius:999px;font-size:12px;background:#f5f3ff;color:#4f46e5;}
    .h2{font-weight:600;font-size:16px;}
    .stickybar{position:sticky;top:0;z-index:40;backdrop-filter:blur(6px);background:rgba(255,255,255,.85);}
    .hidden-block{max-height:6.5rem;overflow:hidden;}
  </style>
</head>
<body class="text-[15px] text-gray-900">
  <div class="max-w-md mx-auto p-4 space-y-4">
    <header class="flex items-center justify-between">
      <div>
        <div class="text-xl font-bold tracking-tight">Selfy AI</div>
        <div class="text-xs text-gray-500 mt-0.5">ç§»åŠ¨ç‰ˆ Â· å§¿æ€ / ç¥æƒ… / é¢ç›¸</div>
      </div>
      <div class="text-xs text-gray-500"><a id="docs" class="underline" target="_blank">/docs</a></div>
    </header>

    <section class="card">
      <!-- æ”¹æˆ label å…œåº•ï¼šå³ä½¿ JS æ²¡è·‘ä¹Ÿèƒ½ç‚¹å¼€ç³»ç»Ÿé€‰å›¾ -->
      <label id="drop" for="file" role="button"
             class="border-2 border-dashed border-gray-300 rounded-xl p-4 text-center hover:border-indigo-400 transition cursor-pointer bg-gray-50">
        <div class="text-gray-600 text-sm">ç‚¹æ­¤é€‰æ‹©å›¾ç‰‡ï¼Œæˆ–æ‹–æ‹½åˆ°è¿™é‡Œ<br><span class="text-xs text-gray-400">JPG/PNG â‰¤ 15MB</span></div>
      </label>
      <!-- ä¸ç”¨ display:noneï¼Œæ”¹ä¸ºâ€œè§†è§‰éšè—â€ï¼Œå…¼å®¹ iOS çš„ label ç‚¹å‡» -->
      <input id="file" type="file" accept="image/*"
             style="position:absolute;width:1px;height:1px;opacity:0;left:-9999px;top:auto;overflow:hidden;" />
      <button id="btnUpload" class="w-full mt-3 px-4 py-3 rounded-xl bg-indigo-600 text-white font-medium shadow hover:shadow-md disabled:opacity-50">å¼€å§‹åˆ†æ</button>
      <div class="mt-2 text-xs text-gray-500">* ä»…ç”¨äºæœ¬æ¬¡åˆ†æï¼Œä¸åšå­˜å‚¨ã€‚</div>
      <div id="error" class="mt-2 hidden text-sm text-red-600"></div>
      <div id="progress" class="mt-2 hidden text-sm text-gray-600">æ­£åœ¨åˆ†æâ€¦â€¦</div>
      <div id="previewWrap" class="mt-3 hidden">
        <img id="preview" class="max-h-60 rounded-xl object-contain border mx-auto" />
      </div>
    </section>

    <section id="resultSec" class="space-y-4 hidden">
      <div class="card stickybar">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-2">
            <div id="archetypePill" class="pill">äººæ ¼ç”»åƒ</div>
            <div class="flex items-center gap-2 text-xs text-gray-500">
              <span>å¯ä¿¡åº¦</span>
              <div class="w-28 bg-gray-200 rounded-full h-2 overflow-hidden">
                <div id="confBar" class="bg-indigo-600 h-2 w-0"></div>
              </div>
              <span id="confText"></span>
            </div>
          </div>
          <button id="copyBtn" class="text-xs px-3 py-1.5 border rounded-lg hover:bg-gray-50">å¤åˆ¶å…¨æ–‡</button>
        </div>
      </div>

      <div class="space-y-4">
        <div class="card">
          <div class="h2 mb-1" id="titlePosture">ğŸ§ å§¿æ€</div>
          <div id="postureHex" class="text-sm text-gray-700"></div>
          <div id="postureInterp" class="text-sm text-gray-700 mt-1"></div>
        </div>

        <div class="card">
          <div class="h2 mb-1" id="titleExpr">ğŸ™‚ ç¥æƒ…</div>
          <div id="exprHex" class="text-sm text-gray-700"></div>
          <div id="exprInterp" class="text-sm text-gray-700 mt-1"></div>
        </div>

        <div class="card">
          <div class="h2 mb-1" id="titleFace">ğŸ‘¤ é¢ç›¸</div>
          <div id="faceHex" class="text-sm text-gray-700"></div>
          <div id="faceInterp" class="text-sm text-gray-700 mt-1"></div>
          <div class="mt-2">
            <div class="text-xs text-gray-500 mb-1">äº”å®˜ç»†èŠ‚</div>
            <div id="faceParts" class="text-sm text-gray-700 whitespace-pre-wrap hidden-block"></div>
            <button id="toggleParts" class="mt-2 text-xs text-indigo-600">å±•å¼€æ›´å¤š</button>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="h2 mb-1" id="overviewTitle">ğŸ”® å¦è±¡ç»„åˆ</div>
        <div id="overviewLead" class="text-sm text-gray-800 mb-1"></div>
      </div>

      <div class="card">
        <div class="h2 mb-1">ğŸ’¼ äº‹ä¸š</div>
        <div class="text-xs text-gray-500 mb-1">è¿‘æœŸçŠ¶æ€ï¼š</div>
        <div id="bizInsight" class="text-sm text-gray-700 mb-2 whitespace-pre-wrap"></div>
        <div class="text-xs text-gray-500 mb-1">è¿‘æœŸå»ºè®®ï¼š</div>
        <div id="bizBody" class="text-sm text-gray-800 whitespace-pre-wrap"></div>
      </div>

      <div class="card">
        <div class="h2 mb-1">ğŸ’— æ„Ÿæƒ…</div>
        <div class="text-xs text-gray-500 mb-1">è¿‘æœŸçŠ¶æ€ï¼š</div>
        <div id="loveInsight" class="text-sm text-gray-700 mb-2 whitespace-pre-wrap"></div>
        <div class="text-xs text-gray-500 mb-1">è¿‘æœŸå»ºè®®ï¼š</div>
        <div id="loveBody" class="text-sm text-gray-800 whitespace-pre-wrap"></div>
      </div>
    </section>

    <footer class="text-xs text-gray-500 text-center pb-6">
      <span>åç«¯ï¼š<code id="apiBase"></code></span> Â· <a class="underline" target="_blank" id="docsLink">/docs</a>
    </footer>
  </div>

<script>
const $=(id)=>document.getElementById(id);
$("apiBase").textContent=window.API_BASE; $("docs").href=window.API_BASE+"/docs"; $("docsLink").href=window.API_BASE+"/docs";

const BAGUA_SYMBOLS = {"è‰®":"å±±","ç¦»":"ç«","å…‘":"æ³½","ä¹¾":"å¤©","å¤":"åœ°","éœ‡":"é›·","å·½":"é£","å":"æ°´"};

// â€”â€” äº‹ä»¶ç›‘å¬ï¼šä¸ä½¿ç”¨å¯é€‰é“¾ï¼Œç¡®ä¿è€ç¯å¢ƒå¯è§£æ â€”â€” //
const drop=$("drop");
drop.addEventListener("click",()=>{ const fi=$("file"); if(fi && fi.click) fi.click(); });
drop.addEventListener("dragover",e=>{e.preventDefault(); drop.classList.add("border-indigo-400","bg-indigo-50/30");});
drop.addEventListener("dragleave",()=>{drop.classList.remove("border-indigo-400","bg-indigo-50/30");});
drop.addEventListener("drop",e=>{
  e.preventDefault(); drop.classList.remove("border-indigo-400","bg-indigo-50/30");
  const f = (e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files[0]) || null;
  if(f) setFile(f);
});
$("file").addEventListener("change",e=>{
  const t=e.target||{}; const f = (t.files && t.files[0]) || null;
  if(f) setFile(f);
});

function setFile(f){const url=URL.createObjectURL(f); $("preview").src=url; $("previewWrap").classList.remove("hidden"); window._file=f;}
$("btnUpload").addEventListener("click", analyze);

// â€”â€” å¤åˆ¶å…¨æ–‡ â€”â€” //
$("copyBtn").addEventListener("click", async ()=>{
  try{
    const get = (id)=>{const el=$(id); return (el&&el.textContent||"").trim();};
    const blocks = [];
    blocks.push("Selfy AIï¼ˆç§»åŠ¨ç‰ˆï¼‰");
    blocks.push("äººæ ¼ç”»åƒï¼š"+ get("archetypePill") + "ï½œå¯ä¿¡åº¦ " + get("confText"));
    blocks.push("ğŸ§ å§¿æ€"); blocks.push(get("postureHex")); blocks.push(get("postureInterp"));
    blocks.push("ğŸ™‚ ç¥æƒ…"); blocks.push(get("exprHex"));    blocks.push(get("exprInterp"));
    blocks.push("ğŸ‘¤ é¢ç›¸"); blocks.push(get("faceHex"));    blocks.push(get("faceInterp"));
    const fp = get("faceParts"); if(fp) blocks.push("äº”å®˜ç»†èŠ‚ï¼š\n"+fp);
    blocks.push(get("overviewTitle")); blocks.push(get("overviewLead"));
    blocks.push("ğŸ’¼ äº‹ä¸šï½œè¿‘æœŸçŠ¶æ€");  blocks.push(get("bizInsight"));
    blocks.push("ğŸ’¼ äº‹ä¸šï½œè¿‘æœŸå»ºè®®");  blocks.push(get("bizBody"));
    blocks.push("ğŸ’— æ„Ÿæƒ…ï½œè¿‘æœŸçŠ¶æ€");  blocks.push(get("loveInsight"));
    blocks.push("ğŸ’— æ„Ÿæƒ…ï½œè¿‘æœŸå»ºè®®");  blocks.push(get("loveBody"));
    const text = blocks.filter(Boolean).join("\n");
    await navigator.clipboard.writeText(text);
    const b=$("copyBtn"); const t=b.textContent; b.textContent="å·²å¤åˆ¶"; setTimeout(()=>b.textContent=t,1200);
  }catch(e){}
});

$("toggleParts").addEventListener("click", ()=>{
  const el=$("faceParts"); const btn=$("toggleParts");
  if(el.classList.contains("hidden-block")){el.classList.remove("hidden-block"); btn.textContent="æ”¶èµ·";}
  else{el.classList.add("hidden-block"); btn.textContent="å±•å¼€æ›´å¤š";}
});

// â€”â€” è°ƒåç«¯ â€”â€” //
async function analyze(){
  const f=window._file; if(!f){showErr("è¯·å…ˆé€‰æ‹©å›¾ç‰‡"); return;}
  showErr(null); $("progress").classList.remove("hidden"); $("btnUpload").disabled=true;
  const fd=new FormData(); fd.append("file", f, f.name);
  try{
    const rsp=await fetch(window.API_BASE+"/upload",{method:"POST", body:fd});
    const d=await rsp.json(); if(!rsp.ok) throw new Error((d && d.error) || "æ¥å£é”™è¯¯"); render(d);
  }catch(e){ showErr(e.message||"è¯·æ±‚å¤±è´¥"); }
  finally{ $("progress").classList.add("hidden"); $("btnUpload").disabled=false; }
}
function showErr(msg){ const el=$("error"); if(!msg){el.classList.add("hidden"); el.textContent=""; return;} el.textContent=msg; el.classList.remove("hidden"); }

// â€”â€” æ¸²æŸ“ â€”â€” //
function neutralize(s){
  if(!s) return s;
  return s.replace(/(ä»–|å¥¹|TA|å¯¹æ–¹|å…¶)(çš„)?/g,"")
          .replace(/(åœ¨(é‡‘é’±ä¸äº‹ä¸š|é…å¶ä¸æ„Ÿæƒ…|äº‹ä¸š|æ„Ÿæƒ…)(æ–¹é¢|ä¸­|é‡Œ)?|ç›®å‰|è¿‘æœŸ|å½“ä¸‹)[ï¼Œã€ï¼š ]*/g,"")
          .replace(/(å¯èƒ½|æˆ–è®¸|ä¹Ÿè®¸)[ï¼Œã€ ]*/g,"")
          .replace(/[ï¼Œ,]{2,}/g,"ï¼Œ")
          .replace(/[ï¼›;]{2,}/g,"ï¼›")
          .trim();
}
function fmtSection(o){
  o=o||{};
  const desc = (o["è¯´æ˜"]||"").trim().replace(/^(ä»–|å¥¹|TA|ä½ |å¯¹æ–¹|å…¶)(çš„)?[ï¼Œã€ï¼š ]*/,"");
  const hex  = (o["å¦è±¡"]||"").trim();
  const interp=(o["è§£è¯»"]||"").trim().replace(/^(ä»–|å¥¹|TA|ä½ |å¯¹æ–¹|å…¶)(çš„)?[ï¼Œã€ï¼š ]*/,"");
  const sym = BAGUA_SYMBOLS[hex] ? "ï¼ˆ"+BAGUA_SYMBOLS[hex]+"ï¼‰" : "";
  const line2 = hex ? ("å¦è±¡ï¼š"+hex+"å¦"+sym) : "";
  const body = [desc, interp].filter(Boolean).join("ï¼Œ");
  const line3 = body ? ("è§£è¯»ï¼š"+body) : "";
  return {line2, line3};
}
function render(d){
  $("resultSec").classList.remove("hidden");

  const tag=((d&&d.meta&&d.meta.headline&&d.meta.headline.tag) || d.archetype || "äººæ ¼ç”»åƒ");
  const confVal=(d&&d.meta&&d.meta.headline&&typeof d.meta.headline.confidence==="number")
                 ? d.meta.headline.confidence : (d.confidence||0);
  $("archetypePill").textContent=tag;
  const conf=Math.round(confVal*100);
  $("confBar").style.width=Math.min(conf,100)+"%";
  $("confText").textContent=conf+"%";

  $("titlePosture").textContent="ğŸ§ å§¿æ€"; $("titleExpr").textContent="ğŸ™‚ ç¥æƒ…"; $("titleFace").textContent="ğŸ‘¤ é¢ç›¸";

  const ta=(d&&d.meta&&d.meta.triple_analysis)||{};
  const s1=fmtSection(ta["å§¿æ€"]); $("postureHex").textContent=s1.line2; $("postureInterp").textContent=s1.line3;
  const s2=fmtSection(ta["ç¥æƒ…"]); $("exprHex").textContent=s2.line2; $("exprInterp").textContent=s2.line3;
  const s3=fmtSection(ta["é¢å®¹"]); $("faceHex").textContent=s3.line2; $("faceInterp").textContent=s3.line3;

  const fp=(d&&d.meta&&d.meta.face_parts)||{}; const lines=[];
  [["çœ‰","çœ‰"],["çœ¼","çœ¼"],["é¼»","é¼»"],["å˜´","å˜´"],["é¢§/ä¸‹å·´","é¢§/ä¸‹å·´"]].forEach(([k,lab])=>{
    const it=fp[k]; if(it){ const feat=(it["ç‰¹å¾"]||"").trim(); const inter=(it["è§£è¯»"]||"").trim(); lines.push(lab+"ï¼š"+feat+(inter?("ï¼›"+inter):"")); }
  });
  $("faceParts").textContent=lines.join("\n");

  const overviewCard=(d&&d.meta&&d.meta.overview_card)||{};
  $("overviewTitle").textContent = overviewCard.title || "ğŸ”® å¦è±¡ç»„åˆ";
  $("overviewLead").textContent  = overviewCard.summary || d.summary || "";

  // äº‹ä¸š/æ„Ÿæƒ…ï¼šä¼˜å…ˆæ¸²æŸ“åˆ—è¡¨è¦ç‚¹ï¼Œå¦åˆ™å›é€€åˆ°å­—ç¬¦ä¸²
  const dsListBiz = d&&d.meta&&d.meta.domains_status_list&&d.meta.domains_status_list["äº‹ä¸š"];
  const dsListLove= d&&d.meta&&d.meta.domains_status_list&&d.meta.domains_status_list["æ„Ÿæƒ…"];
  $("bizInsight").textContent  = (Array.isArray(dsListBiz)? dsListBiz.map(x=>"Â· "+x).join("\n") : neutralize((d&&d.meta&&d.meta.domains_status&&d.meta.domains_status["äº‹ä¸š"])||""));
  $("loveInsight").textContent = (Array.isArray(dsListLove)? dsListLove.map(x=>"Â· "+x).join("\n") : neutralize((d&&d.meta&&d.meta.domains_status&&d.meta.domains_status["æ„Ÿæƒ…"])||""));

  const sgListBiz = d&&d.meta&&d.meta.domains_suggestion_list&&d.meta.domains_suggestion_list["äº‹ä¸š"];
  const sgListLove= d&&d.meta&&d.meta.domains_suggestion_list&&d.meta.domains_suggestion_list["æ„Ÿæƒ…"];
  $("bizBody").textContent  = (Array.isArray(sgListBiz)?  sgListBiz.map(x=>"Â· "+x).join("\n")
                         : neutralize(((d&&d.meta&&d.meta.domains_suggestion&&d.meta.domains_suggestion["äº‹ä¸š"])
                                       || (d&&d.meta&&d.meta.domains_detail&&d.meta.domains_detail["é‡‘é’±ä¸äº‹ä¸š"]) || "â€”")));
  $("loveBody").textContent = (Array.isArray(sgListLove)? sgListLove.map(x=>"Â· "+x).join("\n")
                         : neutralize(((d&&d.meta&&d.meta.domains_suggestion&&d.meta.domains_suggestion["æ„Ÿæƒ…"])
                                       || (d&&d.meta&&d.meta.domains_detail&&d.meta.domains_detail["é…å¶ä¸æ„Ÿæƒ…"]) || "â€”")));
}
</script>
</body>
</html>
