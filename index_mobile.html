<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>Selfy AIï¼ˆç§»åŠ¨ç‰ˆï¼‰</title>
  <style>
    :root { --bg:#0b0b0f; --card:#12121a; --muted:#8a8fa3; --text:#e9ebf1; --brand:#7aa2ff; }
    * { box-sizing: border-box; }
    body { margin:0; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"PingFang SC","Hiragino Sans GB","Microsoft Yahei",system-ui,sans-serif; background:var(--bg); color:var(--text); }
    header { padding:14px 16px; position:sticky; top:0; background:linear-gradient(180deg,#0b0b0f,rgba(11,11,15,.6)); backdrop-filter:blur(6px); border-bottom:1px solid rgba(255,255,255,.06); z-index:10; }
    h1 { font-size:18px; margin:0; letter-spacing:.5px; }
    main { padding:14px 16px 32px; max-width:720px; margin:0 auto; }
    /* â€”â€” Uploader â€”â€” */
    .uploader { display:flex; gap:10px; align-items:center; margin:10px 0 18px; }
    input[type=file]{ display:none; } /* åªä¿ç•™ä¸€å¤„ inputï¼Œé¿å…é‡å¤æŒ‰é’® */
    .btn { background:#1a1b25; color:#e9ebf1; padding:10px 14px; border-radius:12px; border:1px solid rgba(255,255,255,.1); font-size:14px; cursor:pointer; }
    .btn:active { transform:scale(.98) }

    /* â€”â€” Cards â€”â€” */
    .card { background:var(--card); border:1px solid rgba(255,255,255,.08); border-radius:16px; padding:14px; margin:12px 0; box-shadow:0 6px 18px rgba(0,0,0,.25); }
    .title { font-weight:700; margin-bottom:8px; font-size:15px; }
    .muted { color:var(--muted); font-size:13px; }
    .kv { display:flex; gap:8px; font-size:14px; line-height:1.5; align-items:flex-start; }
    .kv b { width:64px; color:#aeb6d9; flex-shrink:0; }
    .hr { height:1px; background:rgba(255,255,255,.06); margin:10px -14px; }
    .bullets { display:flex; flex-wrap:wrap; gap:6px; margin-top:6px; }
    .pill { background:#161722; border:1px solid rgba(255,255,255,.08); padding:6px 8px; border-radius:999px; font-size:12px; color:#c9d1ff }
    .loading { opacity:.7 }

    /* å›¾ç‰‡é¢„è§ˆ */
    img.preview { width:100%; border-radius:12px; margin:10px 0; border:1px solid rgba(255,255,255,.08); display:none; }

    /* ä¸‰åˆ†è±¡ï¼šé»˜è®¤çºµå‘ï¼›æ¨ªå±æˆ–å¤§å±æ—¶å¹¶æ’ */
    .tri-grid { display:grid; grid-template-columns:1fr; gap:10px; }
    @media (min-width:680px){ .tri-grid { grid-template-columns:repeat(3,1fr); } }

    /* å®‰å…¨çš„å¤šè¡Œæ¸²æŸ“ */
    .para { font-size:14px; line-height:1.7; white-space:pre-line; }
  </style>
</head>
<body>
  <header><h1>Selfy AIï¼ˆç§»åŠ¨ç‰ˆï¼‰</h1></header>
  <main>
    <!-- ä»…ä¿ç•™ä¸€ç»„æŒ‰é’® -->
    <div class="uploader">
      <label class="btn" for="file">é€‰æ‹©å›¾ç‰‡</label>
      <input id="file" type="file" accept="image/*" />
      <button id="shot" class="btn" type="button">æ‹ç…§</button>
    </div>

    <img id="preview" class="preview" alt="é¢„è§ˆ"/>

    <!-- åˆå§‹ä¸æ¸²æŸ“ä»»ä½•ç»“æœ -->
    <div id="out"></div>
  </main>

  <script>
    // â€”â€” å¸¸é‡/å¼•ç”¨ â€”â€” //
    const SYMBOLS = {"è‰®":"å±±","ç¦»":"ç«","å…‘":"æ³½","ä¹¾":"å¤©","å¤":"åœ°","éœ‡":"é›·","å·½":"é£","å":"æ°´"};
    const fileInput = document.getElementById('file');
    const shotBtn   = document.getElementById('shot');
    const out       = document.getElementById('out');
    const preview   = document.getElementById('preview');

    // â€œæ‹ç…§â€ä»…åœ¨éœ€è¦æ—¶å¯ç”¨ capture å±æ€§
    shotBtn.addEventListener('click', () => {
      fileInput.setAttribute('capture','environment');
      fileInput.click();
    });
    // ç‚¹å‡»â€œé€‰æ‹©å›¾ç‰‡â€æ—¶ç§»é™¤ captureï¼Œé¿å…åŒå…¥å£å¯¼è‡´çš„ç³»ç»Ÿ UI é‡å¤
    document.querySelector('label[for=file]').addEventListener('click', () => {
      fileInput.removeAttribute('capture');
    });

    // é€‰æ‹©å›¾ç‰‡ -> é¢„è§ˆ + è°ƒç”¨ /upload
    fileInput.addEventListener('change', async (e) => {
      const f = e.target.files?.[0];
      if (!f) return;

      // æ¸…ç©ºæ—§ç»“æœï¼Œæ˜¾ç¤ºå›¾ç‰‡ä¸â€œåˆ†æä¸­â€¦â€
      out.innerHTML = '';
      const url = URL.createObjectURL(f);
      preview.src = url; preview.style.display = 'block';
      out.innerHTML = '<div class="card loading">åˆ†æä¸­â€¦</div>';

      const fd = new FormData();
      fd.append('file', f, f.name || 'image.jpg');

      try {
        const r = await fetch('/upload', { method:'POST', body:fd });
        if (!r.ok) throw new Error('HTTP ' + r.status);
        const data = await r.json();
        render(data);
      } catch (err) {
        out.innerHTML = `<div class="card">å‡ºé”™äº†ï¼š${(err && err.message) || err}</div>`;
      }
    });

    // â€”â€” æ¸²æŸ“é€»è¾‘ï¼ˆä»…åœ¨æ‹¿åˆ°æ•°æ®åæ¸²æŸ“ï¼‰ â€”â€” //
    function pct(n){ try{ return Math.round(n*100); }catch(e){ return 0; } }
    function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])); }

    function triBlock(name, o){
      const hex = o?.['å¦è±¡'] || '';
      const sym = SYMBOLS[hex] || '';
      const rows = [
        `<div class="kv"><b>å¦è±¡</b><span>${hex ? `${hex}å¦ï¼ˆ${sym}ï¼‰` : 'â€”'}</span></div>`,
        `<div class="kv"><b>è§£è¯»</b><span>${escapeHtml(o?.['è§£è¯»'] || 'â€”')}</span></div>`
      ];
      if (o?.['ç»æ–‡æç¤º']) rows.push(`<div class="kv"><b>ç»æ–‡æç¤º</b><span>${escapeHtml(o['ç»æ–‡æç¤º'])}</span></div>`);
      return `<div class="card"><div class="title">${name}</div>${rows.join('')}</div>`;
    }

    function faceBlock(face, parts){
      const hex = face?.['å¦è±¡'] || '';
      const sym = SYMBOLS[hex] || '';
      let rows = [
        `<div class="kv"><b>å¦è±¡</b><span>${hex ? `${hex}å¦ï¼ˆ${sym}ï¼‰` : 'â€”'}</span></div>`,
        `<div class="kv"><b>è§£è¯»</b><span>${escapeHtml(face?.['è§£è¯»'] || 'â€”')}</span></div>`
      ];
      if (face?.['ç»æ–‡æç¤º']) rows.push(`<div class="kv"><b>ç»æ–‡æç¤º</b><span>${escapeHtml(face['ç»æ–‡æç¤º'])}</span></div>`);
      // äº”å®˜ç»†èŠ‚ï¼ˆæŒ‰è¡Œå±•ç¤ºï¼‰
      if (parts && Object.keys(parts).length){
        rows.push('<div class="hr"></div>');
        rows = rows.concat(Object.entries(parts).map(([k,v])=>{
          const h = v?.['å¦è±¡'] || '';
          const hs = h ? `${h}å¦ï¼ˆ${SYMBOLS[h]||''}ï¼‰` : 'â€”';
          const line = `${escapeHtml(v?.['ç‰¹å¾']||'')}ï½œ${hs}ï½œ${escapeHtml(v?.['è§£è¯»']||'')}`;
          return `<div class="kv"><b>${escapeHtml(k)}</b><span>${line}</span></div>`;
        }));
      }
      return `<div class="card"><div class="title">ğŸ‘¤ é¢ç›¸</div>${rows.join('')}</div>`;
    }

    function render(d){
      const ta  = d?.meta?.triple_analysis || {};
      const fps = d?.meta?.face_parts || {};
      const cb  = d?.meta?.confidence_breakdown || {};

      const headline = `
        <div class="card">
          <div class="title">Selfy AI</div>
          <div style="font-size:16px; margin:6px 0 2px;">äººæ ¼ç”»åƒï¼š${escapeHtml(d?.archetype || 'â€”')}</div>
          <div class="muted">å›¾ç‰‡æ¸…æ™°åº¦ ${pct(cb['å›¾åƒæ¸…æ™°åº¦']||0)}%</div>
        </div>`;

      const tri = `
        <div class="tri-grid">
          ${triBlock('ğŸ§ å§¿æ€', ta['å§¿æ€']||{})}
          ${triBlock('ğŸ™‚ ç¥æƒ…', ta['ç¥æƒ…']||{})}
          ${faceBlock(ta['é¢å®¹']||{}, fps)}
        </div>`;

      const combo = (()=>{
        const oc = d?.meta?.overview_card || {};
        const text = (oc.summary||'').split('\n').map(ln=>escapeHtml(ln)).join('<br>');
        return `<div class="card"><div class="title">${escapeHtml(oc.title||'å…«å¦ç±»æ¯”')}</div><div class="para">${text}</div></div>`;
      })();

      // è¿‘æœŸè¦ç‚¹ï¼ˆå¦‚æœåç«¯ä»æä¾›ä¸ºâ€œè¯æ¡â€ï¼Œè¿™é‡Œè½¬ä¸ºèƒ¶å›Šï¼›è‹¥æ”¹æˆå¥å­ä¹Ÿèƒ½æ­£å¸¸æ˜¾ç¤ºï¼‰
      const doms = d?.meta?.domains_status_list || {};
      const statusCard = (title, items)=>{
        if (!items || !items.length) return '';
        return `<div class="card"><div class="title">${title}</div><div class="bullets">${items.map(x=>`<span class="pill">${escapeHtml(x)}</span>`).join('')}</div></div>`;
      };

      out.innerHTML = headline + tri + combo +
        statusCard('ğŸ’¼ äº‹ä¸šï½œè¿‘æœŸè¦ç‚¹', doms['äº‹ä¸š']) +
        statusCard('ğŸ’— æ„Ÿæƒ…ï½œè¿‘æœŸè¦ç‚¹', doms['æ„Ÿæƒ…']);
    }
  </script>
</body>
</html>
