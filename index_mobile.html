<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <title>Selfy AI — 易经观相（移动版）</title>
  <script>window.API_BASE = location.origin || "http://127.0.0.1:10000";</script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body{background:radial-gradient(900px 540px at 50% -180px,#f8fafc 0%,#f1f5f9 60%,#e5e7eb 100%);}
    .card{background:#fff;border-radius:16px;box-shadow:0 8px 24px rgba(0,0,0,.06);padding:16px;}
    .pill{display:inline-flex;padding:.25rem .6rem;border-radius:999px;font-size:12px;background:#f5f3ff;color:#4f46e5;}
    .h2{font-weight:600;font-size:16px;}
    .stickybar{position:sticky;top:0;z-index:40;backdrop-filter:blur(6px);background:rgba(255,255,255,.85);}
    .hidden-block{max-height:6.5rem;overflow:hidden;}
  </style>
</head>
<body class="text-[15px] text-gray-900">
  <div class="max-w-md mx-auto p-4 space-y-4">
    <header class="flex items-center justify-between">
      <div>
        <div class="text-xl font-bold tracking-tight">Selfy AI</div>
        <div class="text-xs text-gray-500 mt-0.5">移动版 · 姿态 / 神情 / 面相</div>
      </div>
      <div class="text-xs text-gray-500"><a id="docs" class="underline" target="_blank">/docs</a></div>
    </header>

    <section class="card">
      <div id="drop" class="border-2 border-dashed border-gray-300 rounded-xl p-4 text-center hover:border-indigo-400 transition cursor-pointer bg-gray-50">
        <div class="text-gray-600 text-sm">点此选择图片，或拖拽到这里<br><span class="text-xs text-gray-400">JPG/PNG ≤ 15MB</span></div>
        <input id="file" type="file" accept="image/*" class="hidden" />
      </div>
      <button id="btnUpload" class="w-full mt-3 px-4 py-3 rounded-xl bg-indigo-600 text-white font-medium shadow hover:shadow-md disabled:opacity-50">开始分析</button>
      <div id="helper" class="mt-2 text-xs text-gray-500">* 仅用于本次分析，不做存储。</div>
      <div id="error" class="mt-2 hidden text-sm text-red-600"></div>
      <div id="progress" class="mt-2 hidden text-sm text-gray-600">正在分析……</div>
      <div id="previewWrap" class="mt-3 hidden">
        <img id="preview" class="max-h-60 rounded-xl object-contain border mx-auto" />
      </div>
    </section>

    <section id="resultSec" class="space-y-4 hidden">
      <div class="card stickybar">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-2">
            <div id="archetypePill" class="pill">人格画像</div>
            <div class="flex items-center gap-2 text-xs text-gray-500">
              <span>可信度</span>
              <div class="w-28 bg-gray-200 rounded-full h-2 overflow-hidden">
                <div id="confBar" class="bg-indigo-600 h-2 w-0"></div>
              </div>
              <span id="confText"></span>
            </div>
          </div>
          <button id="copyBtn" class="text-xs px-3 py-1.5 border rounded-lg hover:bg-gray-50">复制全文</button>
        </div>
      </div>

      <div class="space-y-4">
        <div class="card">
          <div class="h2 mb-1" id="titlePosture">🧍 姿态</div>
          <div id="postureDesc" class="text-sm text-gray-700 mb-1"></div>
          <div id="postureHex" class="text-sm text-gray-700"></div>
          <div id="postureInterp" class="text-sm text-gray-700 mt-1"></div>
        </div>

        <div class="card">
          <div class="h2 mb-1" id="titleExpr">🙂 神情</div>
          <div id="exprDesc" class="text-sm text-gray-700 mb-1"></div>
          <div id="exprHex" class="text-sm text-gray-700"></div>
          <div id="exprInterp" class="text-sm text-gray-700 mt-1"></div>
        </div>

        <div class="card">
          <div class="h2 mb-1" id="titleFace">👤 面相</div>
          <div id="faceDesc" class="text-sm text-gray-700 mb-1"></div>
          <div id="faceHex" class="text-sm text-gray-700"></div>
          <div id="faceInterp" class="text-sm text-gray-700 mt-1"></div>
          <div class="mt-2">
            <div class="text-xs text-gray-500 mb-1">五官观察</div>
            <div id="faceParts" class="text-sm text-gray-700 whitespace-pre-wrap hidden-block"></div>
            <button id="toggleParts" class="mt-2 text-xs text-indigo-600">展开更多</button>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="h2 mb-1" id="overviewTitle">🔮 卦象组合</div>
        <div id="overviewLead" class="text-sm text-gray-800 mb-1"></div>
      </div>

      <div class="card">
        <div class="h2 mb-1">💼 事业</div>
        <div class="text-xs text-gray-500 mb-1">近期状态：</div>
        <div id="bizInsight" class="text-sm text-gray-700 mb-2"></div>
        <div class="text-xs text-gray-500 mb-1">近期建议：</div>
        <div id="bizBody" class="text-sm text-gray-800 whitespace-pre-wrap"></div>
      </div>

      <div class="card">
        <div class="h2 mb-1">💗 感情</div>
        <div class="text-xs text-gray-500 mb-1">近期状态：</div>
        <div id="loveInsight" class="text-sm text-gray-700 mb-2"></div>
        <div class="text-xs text-gray-500 mb-1">近期建议：</div>
        <div id="loveBody" class="text-sm text-gray-800 whitespace-pre-wrap"></div>
      </div>
    </section>

    <footer class="text-xs text-gray-500 text-center pb-6">
      <span>后端：<code id="apiBase"></code></span> · <a class="underline" target="_blank" id="docsLink">/docs</a>
    </footer>
  </div>

<script>
const $=(id)=>document.getElementById(id);
$("apiBase").textContent=window.API_BASE; $("docs").href=window.API_BASE+"/docs"; $("docsLink").href=window.API_BASE+"/docs";

const drop=$("drop");
drop.addEventListener("click",()=>$("file").click());
drop.addEventListener("dragover",e=>{e.preventDefault(); drop.classList.add("border-indigo-400","bg-indigo-50/30");});
drop.addEventListener("dragleave",e=>{drop.classList.remove("border-indigo-400","bg-indigo-50/30");});
drop.addEventListener("drop",e=>{e.preventDefault(); drop.classList.remove("border-indigo-400","bg-indigo-50/30"); const f=e.dataTransfer.files?.[0]; if(f) setFile(f);});
$("file").addEventListener("change",e=>{const f=e.target.files?.[0]; if(f) setFile(f);});
function setFile(f){const url=URL.createObjectURL(f); $("preview").src=url; $("previewWrap").classList.remove("hidden"); window._file=f;}

$("btnUpload").addEventListener("click", analyze);
$("copyBtn").addEventListener("click", async ()=>{ try{await navigator.clipboard.writeText(document.body.innerText); const b=$("copyBtn"); const t=b.textContent; b.textContent="已复制"; setTimeout(()=>b.textContent=t,1200);}catch(e){} });
$("toggleParts").addEventListener("click", ()=>{
  const el=$("faceParts"); const btn=$("toggleParts");
  if(el.classList.contains("hidden-block")){el.classList.remove("hidden-block"); btn.textContent="收起";}
  else{el.classList.add("hidden-block"); btn.textContent="展开更多";}
});

async function analyze(){
  const f=window._file; if(!f){showErr("请先选择图片"); return;}
  showErr(null); $("progress").classList.remove("hidden"); $("btnUpload").disabled=true;
  const fd=new FormData(); fd.append("file", f, f.name);
  try{
    const rsp=await fetch(window.API_BASE+"/upload",{method:"POST", body:fd});
    const d=await rsp.json(); if(!rsp.ok) throw new Error(d?.error||"接口错误"); render(d);
  }catch(e){ showErr(e.message||"请求失败"); }
  finally{ $("progress").classList.add("hidden"); $("btnUpload").disabled=false; }
}
function showErr(msg){ const el=$("error"); if(!msg){el.classList.add("hidden"); el.textContent=""; return;} el.textContent=msg; el.classList.remove("hidden"); }
function _s(txt){ return (typeof txt==="string")?txt.replace(/\n/g,"\\n"):txt; }

function render(d){
  $("resultSec").classList.remove("hidden");

  const tag=(d?.meta?.headline?.tag||d?.archetype||"人格画像");
  const confVal=Number.isFinite(d?.meta?.headline?.confidence)?d.meta.headline.confidence:(d.confidence||0);
  $("archetypePill").textContent=tag; const conf=Math.round(confVal*100); $("confBar").style.width=Math.min(conf,100)+"%"; $("confText").textContent=conf+"%";
  const titles=d?.meta?.sections_titles||{};
  $("titlePosture").textContent="🧍 "+(titles["姿态"]||"姿态"); $("titleExpr").textContent="🙂 "+(titles["神情"]||"神情"); $("titleFace").textContent="👤 "+(titles["面相"]||"面相");

  const ta=d?.meta?.triple_analysis||{};
  function seg(name){ const o=ta[name]||{}; return{desc:_s(o["说明"]||""), hex:o["卦象"]?("卦象："+o["卦象"]):"", interp:_s(o["解读"]||"")+(o["性格倾向"]?("；"+_s(o["性格倾向"])):"")};}
  const s1=seg("姿态"), s2=seg("神情"), s3=seg("面容");
  $("postureDesc").textContent=s1.desc; $("postureHex").textContent=s1.hex; $("postureInterp").textContent=s1.interp;
  $("exprDesc").textContent=s2.desc; $("exprHex").textContent=s2.hex; $("exprInterp").textContent=s2.interp;
  $("faceDesc").textContent=s3.desc; $("faceHex").textContent=s3.hex; $("faceInterp").textContent=s3.interp;

  const fp=d?.meta?.face_parts||{}; const lines=[];
  [["眉","眉"],["眼","眼"],["鼻","鼻"],["嘴","嘴"],["颧/下巴","颧/下巴"]].forEach(([k,lab])=>{
    const it=fp[k]; if(it){ const feat=_s(it["特征"]||""); const inter=_s(it["解读"]||""); lines.push((lab+"："+feat+(inter?("；"+inter):""))); }
  });
  $("faceParts").textContent=lines.join("\n");

  const oc=d?.meta?.overview_card||{};
  $("overviewTitle").textContent=oc.title||"🔮 卦象组合";
  $("overviewLead").textContent=_s(oc.summary||d.summary||"");

  const status=d?.meta?.domains_status||{}; const dd=d?.meta?.domains_detail||{};
  $("bizInsight").textContent=_s(status["事业"]||"");
  $("loveInsight").textContent=_s(status["感情"]||"");
  $("bizBody").textContent=_s(dd["金钱与事业"]||"—");
  $("loveBody").textContent=_s(dd["配偶与感情"]||"—");
}
</script>
</body>
</html>
